<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品生产进度监控</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .last-updated {
            color: #666;
            font-style: italic;
        }
        .loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>产品生产进度监控</h1>
        <div class="status">
            <button id="refresh-btn">立即刷新</button>
            <span class="last-updated" id="last-updated">最后更新: -</span>
        </div>
        <div id="loading" class="loading">加载数据中...</div>
        <div id="statistics-container">
            <table id="model-statistics">
                <thead>
                    <tr>
                        <th>产品型号</th>
                        <th>工艺分类</th>
                        <th>流程步骤</th>
                        <th>完成数量</th>
                        <th>完成率</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 正确引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- 将所有代码整合在一个文件中，避免引用问题 -->
    <script>
        // 等待页面完全加载
        document.addEventListener('DOMContentLoaded', function() {
            console.log("页面加载完成，初始化应用...");
            
            // 初始化Supabase客户端
            const SUPABASE_URL = "https://mirilhunybcsydhtowqo.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pcmlsaHVueWJjc3lkaHRvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyNjk3MzEsImV4cCI6MjA1Njg0NTczMX0.fQCOraXJXQFshRXxHf2N-VIwTSbEc1hrxXzHP4sIIAw";
            
            // 使用全局的supabase对象
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("Supabase已初始化");
            
            // 定义DOM元素
            const refreshBtn = document.getElementById('refresh-btn');
            const lastUpdatedSpan = document.getElementById('last-updated');
            const loadingDiv = document.getElementById('loading');
            const statisticsTable = document.getElementById('model-statistics').querySelector('tbody');

            // 刷新按钮点击事件
            refreshBtn.addEventListener('click', function() {
                fetchProductionData();
            });

            // 从Supabase获取数据并处理
            async function fetchProductionData() {
                try {
                    console.log("开始获取数据...");
                    // 显示加载中
                    loadingDiv.style.display = 'block';
                    loadingDiv.textContent = "正在连接数据库...";
                    statisticsTable.innerHTML = '';
                    
                    // 测试连接
                    console.log("测试Supabase连接...");
                    try {
                        const { data: testData, error: testError } = await supabaseClient
                            .from('products')
                            .select('count', { count: 'exact', head: true });
                            
                        if (testError) {
                            throw testError;
                        }
                        console.log("连接成功，数据库可访问");
                        loadingDiv.textContent = "数据库连接成功，正在获取数据...";
                    } catch (connError) {
                        console.error("数据库连接测试失败:", connError);
                        loadingDiv.textContent = `数据库连接失败: ${connError.message}`;
                        loadingDiv.className = "loading error";
                        if (connError.message.includes("cors") || connError.message.includes("CORS")) {
                            loadingDiv.textContent += "\n可能是跨域问题，请使用本地服务器运行此页面";
                        }
                        return;
                    }
                    
                    // 1. 获取model_series数据（产品型号与工艺分类的对应关系）
                    console.log("获取model_series数据...");
                    loadingDiv.textContent = "正在获取工艺分类数据...";
                    const { data: modelSeries, error: modelSeriesError } = await supabaseClient
                        .from('model_series')
                        .select('*');
                        
                    if (modelSeriesError) {
                        console.error("获取model_series失败:", modelSeriesError);
                        throw modelSeriesError;
                    }
                    console.log(`获取到${modelSeries?.length || 0}条model_series数据`);
                    
                    // 2. 获取series_processes数据（工艺分类对应的工艺流程）
                    console.log("获取series_processes数据...");
                    loadingDiv.textContent = "正在获取工艺流程数据...";
                    const { data: seriesProcesses, error: seriesProcessesError } = await supabaseClient
                        .from('series_processes')
                        .select('*');
                        
                    if (seriesProcessesError) {
                        console.error("获取series_processes失败:", seriesProcessesError);
                        throw seriesProcessesError;
                    }
                    console.log(`获取到${seriesProcesses?.length || 0}条series_processes数据`);
                    
                    // 3. 获取products数据（产品信息）
                    console.log("获取products数据...");
                    loadingDiv.textContent = "正在获取产品数据...";
                    const { data: products, error: productsError } = await supabaseClient
                        .from('products')
                        .select('*');
                        
                    if (productsError) {
                        console.error("获取products失败:", productsError);
                        throw productsError;
                    }
                    console.log(`获取到${products?.length || 0}条products数据`);
                    
                    // 处理数据并展示
                    loadingDiv.textContent = "正在处理数据...";
                    processAndDisplayData(modelSeries, seriesProcesses, products);
                    
                    // 隐藏加载中提示
                    loadingDiv.style.display = 'none';
                    
                    // 更新最后刷新时间
                    const now = new Date();
                    lastUpdatedSpan.textContent = `最后更新: ${now.toLocaleString()}`;
                } catch (error) {
                    console.error('获取数据出错:', error);
                    loadingDiv.textContent = `加载失败: ${error.message}`;
                    loadingDiv.className = "loading error";
                }
            }

            // 处理数据并显示在表格中
            function processAndDisplayData(modelSeries, seriesProcesses, products) {
                // 创建型号到工艺分类的映射
                const modelToSeries = {};
                modelSeries.forEach(item => {
                    modelToSeries[item.model] = item.series;
                });
                
                // 创建工艺分类到工艺流程的映射
                const seriesToProcesses = {};
                seriesProcesses.forEach(item => {
                    if (!seriesToProcesses[item.series]) {
                        seriesToProcesses[item.series] = [];
                    }
                    seriesToProcesses[item.series].push({
                        process: item.process,
                        step: item.step
                    });
                });
                
                // 分组产品数据，按型号统计
                const productsByModel = {};
                products.forEach(product => {
                    const model = product.产品型号;
                    if (!model) return; // 跳过没有型号的产品
                    
                    if (!productsByModel[model]) {
                        productsByModel[model] = [];
                    }
                    productsByModel[model].push(product);
                });
                
                // 生成统计结果
                const statistics = [];
                
                for (const model in productsByModel) {
                    const products = productsByModel[model];
                    const series = modelToSeries[model];
                    
                    if (!series || !seriesToProcesses[series]) {
                        // 跳过没有对应工艺分类或工艺流程的型号
                        statistics.push({
                            model,
                            series: series || '未知',
                            processes: '未定义',
                            completedCount: 0,
                            totalCount: products.length,
                            completionRate: '0%'
                        });
                        continue;
                    }
                    
                    // 获取工艺流程
                    const processes = seriesToProcesses[series];
                    // 按工艺流程步骤排序
                    processes.sort((a, b) => a.step - b.step);
                    
                    // 计算完成最后一步的产品数量
                    let completedCount = 0;
                    
                    products.forEach(product => {
                        // 根据检验时间判断是否完成各工艺步骤
                        // 这里简化处理，如果有成品检验时间，视为完成所有工艺
                        if (product.成品检验时间) {
                            completedCount++;
                        }
                    });
                    
                    // 计算完成率
                    const completionRate = products.length > 0 
                        ? ((completedCount / products.length) * 100).toFixed(2) + '%' 
                        : '0%';
                    
                    // 添加到统计结果
                    statistics.push({
                        model,
                        series,
                        processes: processes.map(p => p.process).join(' -> '),
                        completedCount,
                        totalCount: products.length,
                        completionRate
                    });
                }
                
                // 清空现有表格内容
                statisticsTable.innerHTML = '';
                
                // 生成表格行
                statistics.forEach(stat => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${stat.model}</td>
                        <td>${stat.series}</td>
                        <td>${stat.processes}</td>
                        <td>${stat.completedCount}/${stat.totalCount}</td>
                        <td>${stat.completionRate}</td>
                    `;
                    
                    statisticsTable.appendChild(row);
                });
                
                console.log(`已生成 ${statistics.length} 条统计数据`);
            }

            // 设置每分钟轮询
            const POLL_INTERVAL = 60 * 1000; // 60秒
            setInterval(fetchProductionData, POLL_INTERVAL);

            // 页面加载完成后立即获取数据
            fetchProductionData();
        });
    </script>
</body>
</html>