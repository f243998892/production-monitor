<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品生产进度监控</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        /* 响应式布局样式 */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        @media (max-width: 992px) {
            .panel {
                flex-direction: column;
            }
            .filter-panel, .data-panel {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
            table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 768px) {
            .filter-form-row {
                flex-direction: column;
            }
            .filter-form-group {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            cursor: pointer; /* 添加指针样式，表示可点击排序 */
        }
        th:hover {
            background-color: #e8e8e8; /* 鼠标悬停效果 */
        }
        th.sorted-asc::after {
            content: " ↑";
            color: #4CAF50;
        }
        th.sorted-desc::after {
            content: " ↓";
            color: #4CAF50;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .last-updated {
            color: #666;
            font-style: italic;
        }
        .loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        
        /* 筛选面板样式 */
        .filter-panel {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .filter-group select, .filter-group input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #searchInput {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 300px;
        }
        .clearFilters {
            background-color: #f44336;
        }
        .clearFilters:hover {
            background-color: #d32f2f;
        }
        
        /* 标签页样式 */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .tab-button:hover {
            background-color: #e8e8e8;
        }
        
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* 刷新状态显示 */
        #refreshStatus {
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        
        /* 添加预计完成时间分析样式 */
        .completion-analysis {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .completion-card {
            display: inline-block;
            padding: 10px 15px;
            margin: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            border-left: 4px solid #4CAF50;
        }
        .completion-card strong {
            color: #333;
        }
        .completion-card.urgent {
            border-left-color: #f44336;
        }
        .completion-card.delayed {
            border-left-color: #ff9800;
        }
        .export-settings {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-checkbox {
            margin-right: 5px;
        }
        .cache-status {
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
            padding: 5px 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
            display: inline-block;
        }
        
        /* 增强响应式布局 */
        @media (max-width: 768px) {
            .filter-panel {
                flex-direction: column;
            }
            .filter-group {
                margin-bottom: 10px;
                width: 100%;
            }
            table {
                font-size: 12px;
            }
            .completion-card {
                width: 100%;
                margin: 5px 0;
            }
            .export-settings {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <!-- 引入Excel导出库 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>产品生产进度监控</h1>
        
        <!-- 筛选面板 -->
        <div class="filter-panel">
            <div class="filter-group">
                <label for="modelFilter">产品型号</label>
                <select id="modelFilter">
                    <option value="">全部型号</option>
                    <!-- 将通过JS动态填充 -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="seriesFilter">工艺分类</label>
                <select id="seriesFilter">
                    <option value="">全部分类</option>
                    <!-- 将通过JS动态填充 -->
                </select>
            </div>
            
            <!-- 添加工序选择下拉框 -->
            <div class="filter-group">
                <label for="processFilter">工序筛选</label>
                <select id="processFilter">
                    <option value="">全部工序</option>
                    <option value="绕线">绕线</option>
                    <option value="嵌线">嵌线</option>
                    <option value="接线">接线</option>
                    <option value="压装">压装</option>
                    <option value="成品检验">成品检验</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchInput">搜索</label>
                <input type="text" id="searchInput" placeholder="输入关键字搜索...">
            </div>
            
            <div class="filter-group">
                <button id="applyFilters">应用筛选</button>
                <button id="clearFilters" class="clearFilters">清除筛选</button>
            </div>
            
            <!-- 刷新设置 -->
            <div class="filter-group">
                <label for="refreshInterval">自动刷新频率</label>
                <select id="refreshInterval">
                    <option value="0">关闭自动刷新</option>
                    <option value="30">30秒</option>
                    <option value="60" selected>1分钟</option>
                    <option value="300">5分钟</option>
                    <option value="600">10分钟</option>
                    <option value="1800">30分钟</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button id="saveRefreshSettings">保存刷新设置</button>
            </div>
            
            <!-- 新增日期范围筛选 -->
            <div class="filter-item">
                <label for="date-start">日期范围：</label>
                <input type="date" id="date-start" class="date-filter">
                <span>至</span>
                <input type="date" id="date-end" class="date-filter">
            </div>
        </div>
        
        <div class="status">
            <button id="refresh-btn">立即刷新</button>
            <span class="last-updated" id="last-updated">最后更新: -</span>
            <div class="cache-status" id="cache-status">缓存状态: 未加载</div>
        </div>
        <div id="loading" class="loading">加载数据中...</div>
        <div id="statistics-container">
            <!-- 标签页导航 -->
            <div class="tabs">
                <button class="tab-button active" data-tab="products">产品型号视图</button>
                <button class="tab-button" data-tab="employees">员工视图</button>
            </div>
            
            <!-- 标签页内容 -->
            <div class="tab-content">
                <!-- 产品型号视图 -->
                <div id="products-tab" class="tab-pane active">
            <table id="model-statistics">
                <thead>
                    <tr>
                                <th data-sort="model">产品型号</th>
                                <th data-sort="series">工艺分类</th>
                                <th data-sort="completedCount">完成数量</th>
                                <th data-sort="completionRate">完成率</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
                </div>
                
                <!-- 员工视图 -->
                <div id="employees-tab" class="tab-pane">
                    <table id="employee-statistics">
                        <thead>
                            <tr>
                                <th data-sort="employee">员工姓名</th>
                                <th data-sort="processType">主要工序</th>
                                <th data-sort="processDetail">工序完成详情</th>
                                <th data-sort="completedCount">完成总数</th>
                                <th data-sort="efficiency">日均产量</th>
                                <th data-sort="lastActive">最近活动</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 正确引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- 将所有代码整合在一个文件中，避免引用问题 -->
    <script>
        // 全局缓存变量，用于存储已获取的数据
        let dataCache = {
            modelSeries: null,
            seriesProcesses: null,
            products: null,
            lastFetch: null
        };

        // 优化的数据获取函数，支持缓存和选择性获取
        async function fetchSupabaseData(tables = ['modelSeries', 'seriesProcesses', 'products'], forceRefresh = false) {
            const SUPABASE_URL = "https://mirilhunybcsydhtowqo.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pcmlsaHVueWJjc3lkaHRvd3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyNjk3MzEsImV4cCI6MjA1Njg0NTczMX0.fQCOraXJXQFshRXxHf2N-VIwTSbEc1hrxXzHP4sIIAw";
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            };
            
            // 如果有缓存且未强制刷新，则使用缓存
            if (dataCache.lastFetch && !forceRefresh) {
                console.log("使用缓存数据...");
                
                // 过滤出需要获取的表
                const result = {};
                tables.forEach(table => {
                    if (dataCache[table]) {
                        result[table] = dataCache[table];
                    }
                });
                
                // 如果所有请求的表都有缓存，直接返回
                if (Object.keys(result).length === tables.length) {
                    console.log("所有请求的表都有缓存数据");
                    return result;
                }
            }
            
            console.log("获取数据中...");
            const result = {};
            
            try {
                // 获取model_series数据
                if (tables.includes('modelSeries') && (!dataCache.modelSeries || forceRefresh)) {
                    console.log("获取model_series数据...");
                    const modelSeriesResponse = await fetch(`${SUPABASE_URL}/rest/v1/model_series?select=*`, { headers });
                    const modelSeries = await modelSeriesResponse.json();
                    result.modelSeries = modelSeries;
                    dataCache.modelSeries = modelSeries;
                    console.log(`获取到${modelSeries?.length || 0}条model_series数据`);
                } else if (tables.includes('modelSeries')) {
                    result.modelSeries = dataCache.modelSeries;
                }
                
                // 获取series_processes数据
                if (tables.includes('seriesProcesses') && (!dataCache.seriesProcesses || forceRefresh)) {
                    console.log("获取series_processes数据...");
                    const seriesProcessesResponse = await fetch(`${SUPABASE_URL}/rest/v1/series_processes?select=*`, { headers });
                    const seriesProcesses = await seriesProcessesResponse.json();
                    result.seriesProcesses = seriesProcesses;
                    dataCache.seriesProcesses = seriesProcesses;
                    console.log(`获取到${seriesProcesses?.length || 0}条series_processes数据`);
                } else if (tables.includes('seriesProcesses')) {
                    result.seriesProcesses = dataCache.seriesProcesses;
                }
                
                // 分页获取products数据
                if (tables.includes('products') && (!dataCache.products || forceRefresh)) {
                    console.log("获取products数据...");
                    let allProducts = [];
                    let page = 0;
                    const pageSize = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const offset = page * pageSize;
                        console.log(`获取products数据，页码: ${page+1}，偏移量: ${offset}`);
                        
                        try {
                            const productsResponse = await fetch(
                                `${SUPABASE_URL}/rest/v1/products?select=*&limit=${pageSize}&offset=${offset}`, 
                                { headers }
                            );
                            
                            if (!productsResponse.ok) {
                                throw new Error(`获取products失败: ${productsResponse.statusText}`);
                            }
                            
                            const products = await productsResponse.json();
                            
                            if (products.length === 0) {
                                hasMore = false;
                            } else {
                                allProducts = allProducts.concat(products);
                                page++;
                                // 显示进度提示
                                document.getElementById('loading').textContent = `已加载 ${allProducts.length} 条产品数据...`;
                            }
                        } catch (error) {
                            console.error(`获取products页码${page+1}失败:`, error);
                            hasMore = false;
                        }
                    }
                    
                    console.log(`总共获取到 ${allProducts.length} 条产品数据`);
                    result.products = allProducts;
                    dataCache.products = allProducts;
                } else if (tables.includes('products')) {
                    result.products = dataCache.products;
                }
                
                // 更新最后获取时间
                dataCache.lastFetch = new Date();
                
                // 添加缓存更新时间显示
                if (dataCache.lastFetch && !forceRefresh) {
                    const cacheTime = new Date(dataCache.lastFetch);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - cacheTime) / (1000 * 60));
                    
                    updateCacheStatus(`使用${diffMinutes}分钟前的缓存数据`);
                    
                    // 如果缓存时间超过30分钟，提示用户刷新
                    if (diffMinutes > 30) {
                        console.log("缓存数据已超过30分钟，建议刷新");
                        document.getElementById('cache-status').style.color = "#ff9800";
                    }
                }
                
                return result;
            } catch (error) {
                console.error("获取数据失败:", error);
                throw error;
            }
        }
        
        // 延迟初始化应用
        window.initializeApp = function() {
            // 应用初始化代码
            console.log("页面加载完成，初始化应用...");
            
            // 定义DOM元素
            const refreshBtn = document.getElementById('refresh-btn');
            const lastUpdatedSpan = document.getElementById('last-updated');
            const loadingDiv = document.getElementById('loading');
            const statisticsTable = document.getElementById('model-statistics').querySelector('tbody');
            const tableHeader = document.getElementById('model-statistics').querySelector('thead');
            
            // 筛选相关元素
            const modelFilter = document.getElementById('modelFilter');
            const seriesFilter = document.getElementById('seriesFilter');
            const processFilter = document.getElementById('processFilter');
            const searchInput = document.getElementById('searchInput');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const clearFiltersBtn = document.getElementById('clearFilters');
            
            // 存储所有数据和筛选后的数据
            let allStatistics = [];
            let filteredStatistics = [];
            
            // 存储当前排序状态
            let currentSort = {
                column: '',
                direction: 'asc'
            };

            // 刷新按钮点击事件
            refreshBtn.addEventListener('click', function() {
                fetchProductionData(true); // 强制刷新
            });
            
            // 应用筛选按钮点击事件
            applyFiltersBtn.addEventListener('click', function() {
                applyFilters();
            });
            
            // 清除筛选按钮点击事件
            clearFiltersBtn.addEventListener('click', function() {
                clearFilters();
            });
            
            // 搜索框输入事件
            searchInput.addEventListener('input', function() {
                applyFilters();
            });
            
            // 设置表头排序事件
            tableHeader.querySelectorAll('th').forEach(headerCell => {
                headerCell.addEventListener('click', () => {
                    const sortColumn = headerCell.getAttribute('data-sort');
                    if (sortColumn) {
                        sortTable(sortColumn);
                    }
                });
            });

            // 刷新相关变量和函数
            let refreshIntervalId = null;
            const refreshIntervalSelect = document.getElementById('refreshInterval');
            const saveRefreshSettingsBtn = document.getElementById('saveRefreshSettings');
            
            // 创建和添加刷新状态元素
            const refreshStatusSpan = document.createElement('span');
            refreshStatusSpan.id = 'refreshStatus';
            refreshStatusSpan.textContent = '自动刷新未设置';
            document.querySelector('.status').appendChild(refreshStatusSpan);

            // 保存刷新设置
            saveRefreshSettingsBtn.addEventListener('click', function() {
                updateRefreshInterval();
            });

            function updateRefreshInterval() {
                // 清除现有的定时器
                if (refreshIntervalId) {
                    clearInterval(refreshIntervalId);
                    refreshIntervalId = null;
                }
                
                // 获取选定的刷新间隔（秒）
                const intervalSeconds = parseInt(refreshIntervalSelect.value);
                
                // 设置新的定时器（如果间隔不为0）
                if (intervalSeconds > 0) {
                    refreshIntervalId = setInterval(() => fetchProductionData(true), intervalSeconds * 1000);
                    console.log(`已设置自动刷新，频率为 ${intervalSeconds} 秒`);
                    
                    // 更新状态显示
                    document.getElementById('refreshStatus').textContent = 
                        `自动刷新已启用: 每 ${intervalSeconds} 秒`;
                } else {
                    // 更新状态显示
                    document.getElementById('refreshStatus').textContent = '自动刷新已关闭';
                    console.log('自动刷新已关闭');
                }
            }

            // 从Supabase获取数据并处理
            async function fetchProductionData(forceRefresh = false) {
                try {
                    console.log("开始获取数据...");
                    // 显示加载中
                    loadingDiv.style.display = 'block';
                    loadingDiv.textContent = "正在连接数据库...";
                    loadingDiv.className = "loading";
                    
                    // 获取所有需要的数据（只请求一次）
                    const { modelSeries, seriesProcesses, products } = 
                        await fetchSupabaseData(['modelSeries', 'seriesProcesses', 'products'], forceRefresh);
                    
                    if (!modelSeries || modelSeries.length === 0) {
                        throw new Error("没有获取到有效的model_series数据");
                    }
                    
                    if (!seriesProcesses || seriesProcesses.length === 0) {
                        throw new Error("没有获取到有效的series_processes数据");
                    }
                    
                    if (!products || products.length === 0) {
                        throw new Error("没有获取到有效的products数据");
                    }
                    
                    // 处理数据并展示
                    loadingDiv.textContent = "正在处理数据...";
                    allStatistics = processData(modelSeries, seriesProcesses, products);
                    
                    // 更新筛选器选项
                    updateFilterOptions(allStatistics);
                    
                    // 应用初始筛选并显示数据
                    applyFilters();
                    
                    // 保存数据，用于导出
                    window.exportData = {
                        products: products,
                        modelSeries: modelSeries,
                        seriesProcesses: seriesProcesses,
                        modelStatistics: allStatistics
                    };
                    
                    // 隐藏加载中提示
                    loadingDiv.style.display = 'none';
                    
                    // 更新最后刷新时间
                    const now = new Date();
                    lastUpdatedSpan.textContent = `最后更新: ${now.toLocaleString()}`;
                    
                    // 更新缓存状态
                    updateCacheStatus(`数据已刷新: ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('获取数据出错:', error);
                    loadingDiv.textContent = `加载失败: ${error.message}`;
                    loadingDiv.className = "loading error";
                }
            }

            // 处理数据
            function processData(modelSeries, seriesProcesses, products) {
                // 创建型号到工艺分类的映射
                const modelToSeries = {};
                modelSeries.forEach(item => {
                    modelToSeries[item.产品型号] = item.工艺分类;
                });
                
                // 创建工艺分类到工艺流程的映射
                const seriesToProcesses = {};
                seriesProcesses.forEach(item => {
                    const processNames = [];
                    // 按顺序从process_1到process_8提取工序名称
                    for (let i = 1; i <= 8; i++) {
                        const processKey = `process_${i}`;
                        if (item[processKey] && item[processKey].trim() !== '') {
                            processNames.push(item[processKey]);
                        }
                    }
                    seriesToProcesses[item.工艺分类] = processNames;
                });
                
                // 分组产品数据，按型号统计
                const productsByModel = {};
                products.forEach(product => {
                    const model = product.产品型号;
                    if (!model) return; // 跳过没有型号的产品
                    
                    if (!productsByModel[model]) {
                        productsByModel[model] = [];
                    }
                    productsByModel[model].push(product);
                });
                
                // 生成统计结果
                const statistics = [];
                
                // 所有可能的工序及其对应的时间字段
                const allProcesses = ['绕线', '嵌线', '接线', '压装', '半成品检验', '浸漆', '车止口', '成品检验'];
                const processTimeFields = {
                    '绕线': '绕线时间',
                    '嵌线': '嵌线时间',
                    '接线': '接线时间',
                    '压装': '压装时间',
                    '半成品检验': '半成品检验时间',
                    '浸漆': '浸漆时间',
                    '车止口': '车止口时间',
                    '成品检验': '成品检验时间'
                };
                
                for (const model in productsByModel) {
                    const products = productsByModel[model];
                    const series = modelToSeries[model];
                    
                    if (!series || !seriesToProcesses[series]) {
                        // 跳过没有对应工艺分类或工艺流程的型号
                        statistics.push({
                            model,
                            series: series || '未知',
                            processes: '未定义',
                            completedCount: 0,
                            totalCount: products.length,
                            completionRate: '0%',
                            completionRateValue: 0, // 用于排序
                            processCounts: {}, // 各工序完成数量
                            processTimestamps: {} // 各工序的完成时间戳
                        });
                        continue;
                    }
                    
                    // 获取工艺流程
                    const processes = seriesToProcesses[series];
                    
                    // 初始化各工序计数
                    const processCounts = {};
                    const processTimestamps = {};
                    allProcesses.forEach(process => {
                        processCounts[process] = 0;
                        processTimestamps[process] = [];
                    });
                    
                    // 计算各工序完成数量
                    products.forEach(product => {
                        processes.forEach(process => {
                            const timeField = processTimeFields[process];
                            if (timeField && product[timeField]) {
                                processCounts[process]++;
                                
                                // 存储完成时间戳
                                processTimestamps[process].push({
                                    timestamp: product[timeField],
                                    productCode: product.产品编码
                                });
                            }
                        });
                    });
                    
                    // 计算完成率（以最后一道工序为准）
                    const lastProcess = processes[processes.length - 1];
                    const completedCount = processCounts[lastProcess] || 0;
                    const completionRateValue = products.length > 0 
                        ? (completedCount / products.length) * 100 
                        : 0;
                    const completionRate = completionRateValue.toFixed(2) + '%';
                    
                    // 添加到统计结果
                    statistics.push({
                        model,
                        series,
                        processes: processes.join(' -> '),
                        completedCount,
                        totalCount: products.length,
                        completionRate,
                        completionRateValue, // 用于排序
                        processCounts, // 各工序完成数量
                        processTimestamps // 各工序的完成时间戳
                    });
                }
                
                return statistics;
            }
            
            // 更新筛选器选项
            function updateFilterOptions(statistics) {
                // 清空现有选项（保留"全部"选项）
                while (modelFilter.options.length > 1) {
                    modelFilter.remove(1);
                }
                while (seriesFilter.options.length > 1) {
                    seriesFilter.remove(1);
                }
                
                // 收集唯一的型号和工艺分类
                const uniqueModels = new Set();
                const uniqueSeries = new Set();
                
                statistics.forEach(stat => {
                    uniqueModels.add(stat.model);
                    uniqueSeries.add(stat.series);
                });
                
                // 添加型号选项
                [...uniqueModels].sort().forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelFilter.appendChild(option);
                });
                
                // 添加工艺分类选项
                [...uniqueSeries].sort().forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    seriesFilter.appendChild(option);
                });
            }
            
            // 应用筛选
            function applyFilters() {
                const selectedModel = modelFilter.value;
                const selectedSeries = seriesFilter.value;
                const selectedProcess = processFilter.value;
                const searchTerm = searchInput.value.toLowerCase().trim();
                const startDate = document.getElementById('date-start').value 
                    ? new Date(document.getElementById('date-start').value + 'T00:00:00') 
                    : null;
                const endDate = document.getElementById('date-end').value 
                    ? new Date(document.getElementById('date-end').value + 'T23:59:59') 
                    : null;
                
                // 根据当前活动的标签页应用不同的筛选
                const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
                
                if (activeTab === 'products') {
                    // 应用产品型号视图筛选条件
                    // 对所有统计数据进行深拷贝，以防止修改原始数据
                    const tempStatistics = JSON.parse(JSON.stringify(allStatistics));
                    
                    // 筛选符合条件的型号统计
                    filteredStatistics = tempStatistics.filter(stat => {
                        // 型号筛选
                        if (selectedModel && stat.model !== selectedModel) {
                            return false;
                        }
                        
                        // 工艺分类筛选
                        if (selectedSeries && stat.series !== selectedSeries) {
                            return false;
                        }
                        
                        // 搜索筛选
                        if (searchTerm) {
                            const searchableText = `${stat.model} ${stat.series} ${stat.processes}`.toLowerCase();
                            if (!searchableText.includes(searchTerm)) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    // 日期和工序筛选（修改完成数量和完成率）
                    if ((startDate || endDate) && filteredStatistics.length > 0) {
                        filteredStatistics.forEach(stat => {
                            // 如果没有指定工序，则仍然使用最后一道工序统计完成数
                            const processToCheck = selectedProcess || stat.processes.split(' -> ').pop();
                            
                            // 防止工序不存在
                            if (!stat.processTimestamps[processToCheck]) {
                                stat.completedCount = 0;
                                stat.completionRate = '0%';
                                stat.completionRateValue = 0;
                                return;
                            }
                            
                            // 筛选符合日期条件的完成记录
                            const filteredTimestamps = stat.processTimestamps[processToCheck]
                                .filter(item => {
                                    const timestamp = new Date(item.timestamp);
                                    return (!startDate || timestamp >= startDate) && 
                                           (!endDate || timestamp <= endDate);
                                });
                            
                            // 更新完成数量和完成率
                            const dateFilteredCount = filteredTimestamps.length;
                            stat.completedCount = dateFilteredCount;
                            stat.completionRateValue = stat.totalCount > 0 
                                ? (dateFilteredCount / stat.totalCount) * 100 
                                : 0;
                            stat.completionRate = stat.completionRateValue.toFixed(2) + '%';
                            
                            // 将工序筛选信息添加到显示中
                            if (selectedProcess) {
                                stat.processFilterInfo = `(筛选工序: ${processToCheck})`;
                            } else {
                                stat.processFilterInfo = '';
                            }
                        });
                    } else if (selectedProcess && filteredStatistics.length > 0) {
                        // 只有工序筛选而没有日期筛选的情况
                        filteredStatistics.forEach(stat => {
                            const completedCount = stat.processCounts[selectedProcess] || 0;
                            stat.completedCount = completedCount;
                            stat.completionRateValue = stat.totalCount > 0 
                                ? (completedCount / stat.totalCount) * 100 
                                : 0;
                            stat.completionRate = stat.completionRateValue.toFixed(2) + '%';
                            stat.processFilterInfo = `(筛选工序: ${selectedProcess})`;
                        });
                    } else {
                        // 没有工序和日期筛选的情况，为显示添加空信息
                        filteredStatistics.forEach(stat => {
                            stat.processFilterInfo = '';
                        });
                    }
                    
                    // 应用当前排序
                    if (currentSort.column) {
                        sortTableData(currentSort.column, currentSort.direction);
                    }
                    
                    // 更新表格显示
                    displayStatistics(filteredStatistics);
                } else if (activeTab === 'employees') {
                    // 应用员工视图筛选
                    filterEmployeeStatistics(startDate, endDate, searchTerm, selectedProcess);
                }
            }
            
            // 清除筛选
            function clearFilters() {
                modelFilter.value = '';
                seriesFilter.value = '';
                processFilter.value = '';
                searchInput.value = '';
                document.getElementById('date-start').value = '';
                document.getElementById('date-end').value = '';
                
                // 重置到所有数据
                filteredStatistics = JSON.parse(JSON.stringify(allStatistics));
                filteredStatistics.forEach(stat => {
                    stat.processFilterInfo = '';
                });
                
                // 应用当前排序
                if (currentSort.column) {
                    sortTableData(currentSort.column, currentSort.direction);
                }
                
                // 更新表格显示
                displayStatistics(filteredStatistics);
                
                // 如果员工标签页是活动的，重置员工视图
                const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
                if (activeTab === 'employees') {
                    filterEmployeeStatistics(null, null, '', null);
                }
            }
            
            // 排序表格
            function sortTable(column) {
                // 更新排序方向
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                
                // 应用排序
                sortTableData(column, currentSort.direction);
                
                // 更新表格显示
                displayStatistics(filteredStatistics);
                
                // 更新表头排序指示器
                updateSortIndicators(column, currentSort.direction);
            }
            
            // 排序数据
            function sortTableData(column, direction) {
                filteredStatistics.sort((a, b) => {
                    let valueA, valueB;
                    
                    // 根据列选择排序值
                    switch (column) {
                        case 'model':
                            valueA = a.model;
                            valueB = b.model;
                            break;
                        case 'series':
                            valueA = a.series;
                            valueB = b.series;
                            break;
                        case 'processes':
                            valueA = a.processes;
                            valueB = b.processes;
                            break;
                        case 'completedCount':
                            valueA = a.completedCount / a.totalCount; // 按比例排序更有意义
                            valueB = b.completedCount / b.totalCount;
                            break;
                        case 'completionRate':
                            valueA = a.completionRateValue;
                            valueB = b.completionRateValue;
                            break;
                        default:
                            return 0;
                    }
                    
                    // 字符串比较
                    if (typeof valueA === 'string' && typeof valueB === 'string') {
                        return direction === 'asc' 
                            ? valueA.localeCompare(valueB) 
                            : valueB.localeCompare(valueA);
                    }
                    
                    // 数值比较
                    return direction === 'asc' 
                        ? valueA - valueB 
                        : valueB - valueA;
                });
            }
            
            // 更新排序指示器
            function updateSortIndicators(column, direction) {
                // 清除所有表头的排序标志
                tableHeader.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                // 为当前排序列添加指示器
                const th = tableHeader.querySelector(`th[data-sort="${column}"]`);
                if (th) {
                    th.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            }
            
            // 显示统计数据
            function displayStatistics(statistics) {
                // 清空现有表格内容
                statisticsTable.innerHTML = '';
                
                // 如果没有数据，显示提示
                if (statistics.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="4" style="text-align: center;">没有符合条件的数据</td>`;
                    statisticsTable.appendChild(row);
                    return;
                }
                
                // 生成表格行
                statistics.forEach(stat => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${stat.model}</td>
                        <td>${stat.series}</td>
                        <td>${stat.completedCount}/${stat.totalCount} ${stat.processFilterInfo || ''}</td>
                        <td>${stat.completionRate}</td>
                    `;
                    
                    statisticsTable.appendChild(row);
                });
                
                console.log(`显示 ${statistics.length} 条统计数据`);
            }

            // 页面加载完成后立即获取数据
            fetchProductionData();
            
            // 添加Excel导出按钮到筛选面板
            const exportGroup = document.createElement('div');
            exportGroup.className = 'filter-group';
            exportGroup.innerHTML = `
                <button id="export-excel">导出Excel</button>
                <div class="export-settings">
                    <label><input type="checkbox" class="export-checkbox" id="export-details" checked> 包含产品详情</label>
                </div>
            `;
            document.querySelector('.filter-panel').appendChild(exportGroup);
            
            // 绑定Excel导出事件
            document.getElementById('export-excel').addEventListener('click', function() {
                if (!window.exportData) {
                    alert('没有可用的数据进行导出');
                    return;
                }
                
                const includeDetails = document.getElementById('export-details').checked;
                
                exportToExcel(window.exportData, {
                    includeDetails: includeDetails
                });
            });
            
            // 从localStorage恢复刷新设置
            const savedInterval = localStorage.getItem('refreshInterval');
            if (savedInterval) {
                refreshIntervalSelect.value = savedInterval;
                updateRefreshInterval();
            }
        };

        // 加载并初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            window.initializeApp();
            
            // 标签页切换
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有标签页的active类
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    // 添加当前标签页的active类
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                    
                    // 如果切换到员工视图，加载员工数据
                    if (this.getAttribute('data-tab') === 'employees') {
                        fetchEmployeeData();
                    }
                });
            });
        });

        // 获取员工数据
        async function fetchEmployeeData() {
            try {
                // 显示加载中
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = "正在获取员工数据...";
                
                // 确保产品数据已加载
                if (!dataCache.products) {
                    await fetchSupabaseData(['products']);
                }
                
                // 访问全局缓存中的产品数据
                const products = dataCache.products;
                
                if (!products || products.length === 0) {
                    throw new Error("没有可用的产品数据");
                }
                
                // 处理员工数据并显示
                document.getElementById('loading').textContent = "正在处理员工数据...";
                
                // 创建工序与员工字段的映射
                const processToEmployeeField = {
                    '绕线': {field: '绕线员工', timeField: '绕线时间'},
                    '嵌线': {field: '嵌线员工', timeField: '嵌线时间'},
                    '接线': {field: '接线员工', timeField: '接线时间'},
                    '压装': {field: '压装员工', timeField: '压装时间'},
                    '车止口': {field: '车止口员工', timeField: '车止口时间'},
                };
                
                // 创建员工统计数据
                const employeeStats = {};
                
                // 遍历所有产品记录
                products.forEach(product => {
                    // 遍历所有工序
                    for (const [process, fields] of Object.entries(processToEmployeeField)) {
                        const employeeField = fields.field;
                        const timeField = fields.timeField;
                        const employee = product[employeeField];
                        const timestamp = product[timeField];
                        
                        // 如果有员工和时间戳，说明该员工完成了这道工序
                        if (employee && timestamp) {
                            // 初始化该员工的统计记录
                            if (!employeeStats[employee]) {
                                employeeStats[employee] = {
                                    name: employee,
                                    processes: {},
                                    models: {},  // 按产品型号统计
                                    timestamps: [],  // 存储所有时间戳，用于计算活动情况
                                    totalCompleted: 0
                                };
                            }
                            
                            // 初始化该工序的计数
                            if (!employeeStats[employee].processes[process]) {
                                employeeStats[employee].processes[process] = 0;
                            }
                            
                            // 增加完成计数
                            employeeStats[employee].processes[process]++;
                            employeeStats[employee].totalCompleted++;
                            
                            // 记录产品型号
                            const model = product.产品型号 || '未知型号';
                            if (!employeeStats[employee].models[model]) {
                                employeeStats[employee].models[model] = 0;
                            }
                            employeeStats[employee].models[model]++;
                            
                            // 记录时间戳
                            if (timestamp) {
                                employeeStats[employee].timestamps.push({
                                    time: timestamp,
                                    process: process,
                                    productCode: product.产品编码
                                });
                            }
                        }
                    }
                });
                
                // 保存到全局变量供筛选使用
                window.employeeData = employeeStats;
                
                // 转换为数组形式便于展示
                const employeeDataArray = Object.values(employeeStats).map(stat => {
                    // 找出员工完成数量最多的工序
                    let mainProcess = '';
                    let maxCount = 0;
                    
                    for (const [process, count] of Object.entries(stat.processes)) {
                        if (count > maxCount) {
                            maxCount = count;
                            mainProcess = process;
                        }
                    }
                    
                    // 创建工序详情
                    const processDetail = Object.entries(stat.processes)
                        .map(([process, count]) => `${process}: ${count}`)
                        .join(', ');
                    
                    // 计算每天平均完成产品数（效率指数）
                    const efficiency = calculateEfficiency(stat.timestamps);
                    
                    // 获取最近活动
                    let lastActive = '无记录';
                    if (stat.timestamps.length > 0) {
                        // 按时间降序排序
                        stat.timestamps.sort((a, b) => {
                            return new Date(b.time) - new Date(a.time);
                        });
                        
                        // 获取最近的活动
                        const recentActivity = stat.timestamps[0];
                        const activityDate = new Date(recentActivity.time);
                        lastActive = `${activityDate.toLocaleDateString()} (${recentActivity.process})`;
                    }
                    
                    return {
                        employee: stat.name,
                        processType: mainProcess,
                        processDetail: processDetail,
                        completedCount: stat.totalCompleted,
                        efficiency: `${efficiency} 件/天`,
                        lastActive: lastActive,
                        // 存储原始数据，用于展示详情
                        rawData: stat
                    };
                });
                
                // 按总完成数排序
                employeeDataArray.sort((a, b) => b.completedCount - a.completedCount);
                
                // 显示员工数据
                displayEmployeeStatistics(employeeDataArray);
                
                // 隐藏加载中
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('获取员工数据失败:', error);
                document.getElementById('loading').textContent = `加载员工数据失败: ${error.message}`;
                document.getElementById('loading').className = "loading error";
            }
        }

        // 根据工序获取部门名称
        function getEmployeeDepartment(process) {
            // 简单映射工序到部门
            const processToDepartment = {
                '绕线': '绕线部',
                '嵌线': '嵌线部',
                '接线': '接线部',
                '压装': '压装部',
                '车止口': '车止口部'
            };
            
            return processToDepartment[process] || '生产部';
        }

        // 计算员工效率（每天平均完成数量）
        function calculateEfficiency(timestamps) {
            if (!timestamps || timestamps.length === 0) return '0';
            
            // 找出最早和最晚的时间戳
            let earliestDate = null;
            let latestDate = null;
            
            timestamps.forEach(activity => {
                const date = new Date(activity.time);
                if (!earliestDate || date < earliestDate) {
                    earliestDate = date;
                }
                if (!latestDate || date > latestDate) {
                    latestDate = date;
                }
            });
            
            // 计算天数差异
            const daysDiff = Math.max(1, Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24)));
            
            // 计算日均产量
            return (timestamps.length / daysDiff).toFixed(1);
        }

        // 显示员工统计数据
        function displayEmployeeStatistics(employeeData) {
            const tableBody = document.getElementById('employee-statistics').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // 如果没有数据，显示提示
            if (employeeData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">没有员工数据</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // 生成表格行
            employeeData.forEach(stat => {
                const row = document.createElement('tr');
                
                // 添加点击事件展示更多详情
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => showEmployeeDetails(stat.rawData));
                
                row.innerHTML = `
                    <td>${stat.employee}</td>
                    <td>${stat.processType}</td>
                    <td>${stat.processDetail}</td>
                    <td>${stat.completedCount}</td>
                    <td>${stat.efficiency}</td>
                    <td>${stat.lastActive}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // 添加员工详情显示函数
        function showEmployeeDetails(employeeData) {
            // 创建模态框显示员工详细信息
            const modalContainer = document.createElement('div');
            modalContainer.style.position = 'fixed';
            modalContainer.style.top = '0';
            modalContainer.style.left = '0';
            modalContainer.style.width = '100%';
            modalContainer.style.height = '100%';
            modalContainer.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modalContainer.style.display = 'flex';
            modalContainer.style.justifyContent = 'center';
            modalContainer.style.alignItems = 'center';
            modalContainer.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '5px';
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '800px';
            modalContent.style.maxHeight = '80%';
            modalContent.style.overflow = 'auto';
            
            // 添加关闭按钮
            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.float = 'right';
            closeButton.style.padding = '5px 10px';
            closeButton.style.backgroundColor = '#f44336';
            closeButton.style.color = 'white';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '3px';
            closeButton.style.cursor = 'pointer';
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modalContainer);
            });
            
            // 构建详情内容
            const title = document.createElement('h2');
            title.textContent = `员工详情: ${employeeData.name}`;
            
            const processesSection = document.createElement('div');
            processesSection.innerHTML = `<h3>工序完成情况</h3>`;
            
            // 工序完成饼图占位符
            const processChartContainer = document.createElement('div');
            processChartContainer.style.width = '100%';
            processChartContainer.style.height = '300px';
            processChartContainer.style.marginBottom = '20px';
            
            // 产品型号完成情况
            const modelsSection = document.createElement('div');
            modelsSection.innerHTML = `<h3>产品型号完成情况</h3>`;
            
            const modelsList = document.createElement('ul');
            Object.entries(employeeData.models)
                .sort((a, b) => b[1] - a[1]) // 按数量降序排序
                .forEach(([model, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${model}: ${count}件`;
                    modelsList.appendChild(li);
                });
            
            // 最近活动记录
            const recentActivitiesSection = document.createElement('div');
            recentActivitiesSection.innerHTML = `<h3>最近活动记录</h3>`;
            
            const activitiesList = document.createElement('ul');
            // 只显示最近10条记录
            employeeData.timestamps
                .sort((a, b) => new Date(b.time) - new Date(a.time))
                .slice(0, 10)
                .forEach(activity => {
                    const li = document.createElement('li');
                    const activityDate = new Date(activity.time);
                    li.textContent = `${activityDate.toLocaleString()} - ${activity.process} - 产品编码: ${activity.productCode}`;
                    activitiesList.appendChild(li);
                });
            
            // 组装内容
            modalContent.appendChild(closeButton);
            modalContent.appendChild(title);
            modalContent.appendChild(processesSection);
            modalContent.appendChild(processChartContainer);
            modalContent.appendChild(modelsSection);
            modalContent.appendChild(modelsList);
            modalContent.appendChild(recentActivitiesSection);
            modalContent.appendChild(activitiesList);
            
            modalContainer.appendChild(modalContent);
            document.body.appendChild(modalContainer);
        }

        // 增强Excel导出功能
        function exportToExcel(data, options = {}) {
            const defaultOptions = {
                fileName: '产品生产进度_' + new Date().toISOString().split('T')[0],
                includeDetails: true
            };
            
            const exportOptions = { ...defaultOptions, ...options };
            
            // 创建一个新的工作簿
            const workbook = XLSX.utils.book_new();
            
            // 准备数据
            if (exportOptions.includeDetails && data.products) {
                // 产品详情工作表
                const productDetails = data.products.map(product => {
                    // 提取需要的字段，简化数据
                    return {
                        '产品编码': product.产品编码,
                        '产品型号': product.产品型号,
                        '工艺分类': data.modelSeries?.find(m => m.产品型号 === product.产品型号)?.工艺分类 || '未知',
                        '绕线时间': product.绕线时间 ? new Date(product.绕线时间).toLocaleString() : '',
                        '嵌线时间': product.嵌线时间 ? new Date(product.嵌线时间).toLocaleString() : '',
                        '接线时间': product.接线时间 ? new Date(product.接线时间).toLocaleString() : '',
                        '压装时间': product.压装时间 ? new Date(product.压装时间).toLocaleString() : '',
                        '成品检验时间': product.成品检验时间 ? new Date(product.成品检验时间).toLocaleString() : '',
                        '创建时间': product.created_at ? new Date(product.created_at).toLocaleString() : ''
                    };
                });
                
                const productSheet = XLSX.utils.json_to_sheet(productDetails);
                XLSX.utils.book_append_sheet(workbook, productSheet, "产品详情");
            }
            
            // 添加型号统计工作表
            if (data.modelStatistics) {
                const modelSheet = XLSX.utils.json_to_sheet(data.modelStatistics);
                XLSX.utils.book_append_sheet(workbook, modelSheet, "型号统计");
            }
            
            // 导出工作簿
            XLSX.writeFile(workbook, `${exportOptions.fileName}.xlsx`);
        }
        
        // 添加更新缓存状态的函数
        function updateCacheStatus(message) {
            const cacheStatusEl = document.getElementById('cache-status');
            if (cacheStatusEl) {
                cacheStatusEl.textContent = `缓存状态: ${message}`;
                cacheStatusEl.style.color = "#666"; // 重置颜色
            }
        }

        // 添加员工视图筛选函数
        function filterEmployeeStatistics(startDate, endDate, searchTerm, process) {
            if (!window.employeeData) return;
            
            const filteredEmployees = {};
            
            // 遍历所有员工
            Object.entries(window.employeeData).forEach(([employee, data]) => {
                // 应用搜索筛选
                if (searchTerm && !employee.toLowerCase().includes(searchTerm.toLowerCase())) {
                    return;
                }
                
                // 筛选符合条件的活动
                let filteredTimestamps = [...data.timestamps];
                
                // 应用工序筛选
                if (process) {
                    filteredTimestamps = filteredTimestamps.filter(activity => 
                        activity.process === process
                    );
                }
                
                // 应用日期筛选
                if (startDate || endDate) {
                    filteredTimestamps = filteredTimestamps.filter(activity => {
                        const activityDate = new Date(activity.time);
                        return (!startDate || activityDate >= startDate) && 
                               (!endDate || activityDate <= endDate);
                    });
                }
                
                // 如果没有符合条件的活动，排除此员工
                if (filteredTimestamps.length === 0) {
                    return;
                }
                
                // 创建此员工的筛选后数据
                filteredEmployees[employee] = {
                    ...data,
                    timestamps: filteredTimestamps,
                    // 重新计算此日期范围内的统计信息
                    totalCount: filteredTimestamps.length,
                    processTypes: countProcessTypes(filteredTimestamps)
                };
            });
            
            // 将对象转换为数组，与fetchEmployeeData函数中的处理方式相同
            const employeeDataArray = Object.values(filteredEmployees).map(stat => {
                // 找出员工完成数量最多的工序
                let mainProcess = '';
                let maxCount = 0;
                
                for (const [process, count] of Object.entries(stat.processTypes)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mainProcess = process;
                    }
                }
                
                // 创建工序详情
                const processDetail = Object.entries(stat.processTypes)
                    .map(([process, count]) => `${process}: ${count}`)
                    .join(', ');
                
                // 计算每天平均完成产品数（效率指数）
                const efficiency = calculateEfficiency(stat.timestamps);
                
                // 获取最近活动
                let lastActive = '无记录';
                if (stat.timestamps.length > 0) {
                    // 按时间降序排序
                    stat.timestamps.sort((a, b) => {
                        return new Date(b.time) - new Date(a.time);
                    });
                    
                    // 获取最近的活动
                    const recentActivity = stat.timestamps[0];
                    const activityDate = new Date(recentActivity.time);
                    lastActive = `${activityDate.toLocaleDateString()} (${recentActivity.process})`;
                }
                
                return {
                    employee: stat.name,
                    processType: mainProcess,
                    processDetail: processDetail,
                    completedCount: stat.totalCount,
                    efficiency: `${efficiency} 件/天`,
                    lastActive: lastActive,
                    // 存储原始数据，用于展示详情
                    rawData: stat
                };
            });
            
            // 按总完成数排序
            employeeDataArray.sort((a, b) => b.completedCount - a.completedCount);
            
            // 更新员工表格，传递数组而不是对象
            displayEmployeeStatistics(employeeDataArray);
        }

        // 辅助函数：计算工序类型数量
        function countProcessTypes(timestamps) {
            const counts = {};
            timestamps.forEach(activity => {
                counts[activity.process] = (counts[activity.process] || 0) + 1;
            });
            return counts;
        }

        // 修改标签页切换逻辑，添加筛选同步
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有active类
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // 添加active类到当前按钮和对应面板
                    this.classList.add('active');
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // 应用筛选条件到新激活的标签页
                    applyFilters();
                });
            });
        }
    </script>
</body>
</html>
