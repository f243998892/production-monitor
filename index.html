<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品生产进度监控</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        /* 响应式布局样式 */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        @media (max-width: 992px) {
            .panel {
                flex-direction: column;
            }
            .filter-panel, .data-panel {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
            table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 768px) {
            .filter-form-row {
                flex-direction: column;
            }
            .filter-form-group {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .filter-panel {
                flex-direction: column;
            }
            .filter-group {
                margin-bottom: 10px;
                width: 100%;
            }
            table {
                font-size: 12px;
            }
            .completion-card {
                width: 100%;
                margin: 5px 0;
            }
            .export-settings {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            cursor: pointer; /* 添加指针样式，表示可点击排序 */
        }
        th:hover {
            background-color: #e8e8e8; /* 鼠标悬停效果 */
        }
        th.sorted-asc::after {
            content: " ↑";
            color: #4CAF50;
        }
        th.sorted-desc::after {
            content: " ↓";
            color: #4CAF50;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .last-updated {
            color: #666;
            font-style: italic;
        }
        .loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        
        /* 筛选面板样式 */
        .filter-panel {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-start;
            justify-content: space-between;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            margin-bottom: 10px;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .filter-group select, .filter-group input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .date-filter {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        #searchInput {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
        }
        .clearFilters {
            background-color: #f44336;
        }
        .clearFilters:hover {
            background-color: #d32f2f;
        }
        
        /* 标签页样式 */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #e8e8e8;
            color: #555;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .tab-button:hover {
            background-color: #d8d8d8;
            color: #333;
        }
        
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* 刷新状态显示 */
        #refreshStatus {
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        
        /* 添加预计完成时间分析样式 */
        .completion-analysis {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .completion-card {
            display: inline-block;
            padding: 10px 15px;
            margin: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            border-left: 4px solid #4CAF50;
        }
        .completion-card strong {
            color: #333;
        }
        .completion-card.urgent {
            border-left-color: #f44336;
        }
        .completion-card.delayed {
            border-left-color: #ff9800;
        }
        .export-settings {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-checkbox {
            margin-right: 5px;
        }
        .cache-status {
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
            padding: 5px 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
            display: inline-block;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #555;
        }
        
        #modal-process-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .process-badge {
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            border-left: 3px solid #4CAF50;
        }
        
        .recent-activities-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        #modal-recent-activities {
            width: 100%;
            border-collapse: collapse;
        }
        
        #modal-recent-activities th, #modal-recent-activities td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        #modal-recent-activities th {
            background-color: #f8f8f8;
        }
        
        #efficiency-chart-container {
            height: 200px;
            margin-bottom: 20px;
        }
        
        /* 详情按钮样式 */
        .detail-btn {
            padding: 5px 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .detail-btn:hover {
            background-color: #0b7dda;
        }
        
        /* 分析页面样式 */
        .analysis-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        
        .analysis-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .analysis-btn:hover {
            background-color: #45a049;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #555;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .difficulty-high {
            color: #F44336;
        }
        
        .difficulty-medium {
            color: #FFC107;
        }
        
        .difficulty-low {
            color: #4CAF50;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
    </style>
    <!-- 引入Chart.js图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Excel导出库 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>产品生产进度监控</h1>
        
        <!-- 筛选面板 -->
        <div class="filter-panel">
            <div class="filter-group">
                <label for="modelFilter">产品型号</label>
                <select id="modelFilter">
                    <option value="">全部型号</option>
                    <!-- 将通过JS动态填充 -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="seriesFilter">工艺分类</label>
                <select id="seriesFilter">
                    <option value="">全部分类</option>
                    <!-- 将通过JS动态填充 -->
                </select>
            </div>
            
            <!-- 添加工序选择下拉框 -->
            <div class="filter-group">
                <label for="processFilter">工序筛选</label>
                <select id="processFilter">
                    <option value="">全部工序</option>
                    <option value="绕线">绕线</option>
                    <option value="嵌线">嵌线</option>
                    <option value="接线">接线</option>
                    <option value="嵌线/接线">嵌线/接线</option>
                    <option value="压装">压装</option>
                    <option value="成品检验">成品检验</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchInput">搜索</label>
                <input type="text" id="searchInput" placeholder="输入关键字搜索...">
            </div>
            
            <!-- 新增日期范围筛选 -->
            <div class="filter-item">
                <label for="date-start">日期范围：</label>
                <input type="date" id="date-start" class="date-filter">
                <span>至</span>
                <input type="date" id="date-end" class="date-filter">
            </div>
            
            <div class="action-buttons">
                <button id="applyFilters">应用筛选</button>
                <button id="clearFilters" class="clearFilters">清除筛选</button>
                <button id="refresh-btn">立即刷新</button>
                <button id="export-excel">导出Excel</button>
            </div>
            
            <div class="export-settings">
                <label><input type="checkbox" class="export-checkbox" id="export-details" checked> 包含产品详情</label>
            </div>
            
            <!-- 添加特殊工序说明 -->
            <div class="process-note" style="margin-top: 10px; color: #666; font-size: 0.9em;">
                <strong>注意：</strong>"嵌线/接线"表示某些工艺中这两个工序只需完成其中一个即视为完成此阶段。筛选此项会包含任一工序完成的产品。
            </div>
        </div>
        
        <div class="status">
            <span class="last-updated" id="last-updated">最后更新: -</span>
            <div class="cache-status" id="cache-status">缓存状态: 未加载</div>
        </div>
        <div id="loading" class="loading">加载数据中...</div>
        <div id="statistics-container">
            <!-- 标签页导航 -->
            <div class="tabs">
                <button class="tab-button active" data-tab="products">产品型号视图</button>
                <button class="tab-button" data-tab="employees">员工视图</button>
                <button class="tab-button" data-tab="wip">在制品视图</button>
                <button class="tab-button" data-tab="difficulty">难度分析</button>
                <button class="tab-button" data-tab="timing">工序时间分析</button>
            </div>
            
            <!-- 标签页内容 -->
            <div class="tab-content">
                <!-- 产品型号视图 -->
                <div id="products-tab" class="tab-pane active">
            <table id="model-statistics">
                <thead>
                    <tr>
                                <th data-sort="model">产品型号</th>
                                <th data-sort="series">工艺分类</th>
                                <th data-sort="completedCount">完成数量</th>
                                <th data-sort="completionRate">完成率</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
                </div>
                
                <!-- 员工视图 -->
                <div id="employees-tab" class="tab-pane">
                    <table id="employee-statistics">
                        <thead>
                            <tr>
                                <th data-sort="employee">员工姓名</th>
                                <th data-sort="processType">主要工序</th>
                                <th data-sort="processDetail">工序完成详情</th>
                                <th data-sort="completedCount">完成总数</th>
                                <th data-sort="efficiency">日均产量</th>
                                <th data-sort="lastActive">最近活动</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 员工详情模态框 -->
                <div id="employee-detail-modal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2 id="modal-employee-name">员工详情</h2>
                        <div class="employee-info">
                            <p><strong>主要工序:</strong> <span id="modal-process-type"></span></p>
                            <p><strong>完成总数:</strong> <span id="modal-completed-count"></span></p>
                            <p><strong>日均产量:</strong> <span id="modal-efficiency"></span></p>
                            <p><strong>最近活动:</strong> <span id="modal-last-active"></span></p>
                        </div>
                        <h3>工序完成详情</h3>
                        <div id="modal-process-detail"></div>
                        
                        <h3>近期完成记录</h3>
                        <div class="recent-activities-container">
                            <table id="modal-recent-activities">
                                <thead>
                                    <tr>
                                        <th>产品编码</th>
                                        <th>工序</th>
                                        <th>完成时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h3>生产效率趋势</h3>
                        <div id="efficiency-chart-container">
                            <div id="efficiency-chart"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 在制品视图 -->
                <div id="wip-tab" class="tab-pane">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #4CAF50; border-radius: 4px;">
                        <p style="margin: 0; color: #555;"><strong>在制品说明：</strong></p>
                        <ol style="margin: 5px 0 0 20px; padding: 0;">
                            <li>已完成当前工序的产品会自动转移到下一工序状态</li>
                            <li>已完成最后一道工序的产品不会显示在在制品中</li>
                            <li>表格中标记为"-"的工序表示该型号的工艺路线中不包含此工序</li>
                        </ol>
                    </div>
                    <table id="wip-statistics">
                        <thead>
                            <tr>
                                <th data-sort="model">产品型号</th>
                                <th data-sort="series">工艺分类</th>
                                <th data-sort="totalCount">总数量</th>
                                <th data-sort="notStarted">未开始</th>
                                <!-- 动态生成各工序列 -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 产品型号难度分析视图 -->
                <div id="difficulty-tab" class="tab-pane">
                    <div class="analysis-controls">
                        <button id="calculate-difficulty" class="analysis-btn">计算难度系数</button>
                        <div class="filter-group">
                            <label for="diff-metric">难度评估指标</label>
                            <select id="diff-metric">
                                <option value="totalTime">总生产时间</option>
                                <option value="processTime">工序平均时间</option>
                                <option value="cycleTime">生产周期</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="analysis-result">
                        <div id="difficulty-chart-container" style="height: 400px; margin-top: 20px;">
                            <canvas id="difficulty-chart"></canvas>
                        </div>
                        
                        <table id="difficulty-table">
                            <thead>
                                <tr>
                                    <th data-sort="model">产品型号</th>
                                    <th data-sort="series">工艺分类</th>
                                    <th data-sort="avgTime">平均生产时间</th>
                                    <th data-sort="difficultyIndex">难度系数</th>
                                    <th data-sort="sampleCount">样本数量</th>
                                    <th data-sort="processes">工序数量</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 工序时间分析视图 -->
                <div id="timing-tab" class="tab-pane">
                    <div class="analysis-controls">
                        <div class="filter-group">
                            <label for="timing-employee">选择员工</label>
                            <select id="timing-employee">
                                <option value="">全部员工</option>
                                <!-- 动态填充 -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="timing-process">选择工序</label>
                            <select id="timing-process">
                                <option value="">全部工序</option>
                                <option value="绕线">绕线</option>
                                <option value="嵌线">嵌线</option>
                                <option value="接线">接线</option>
                                <option value="嵌线/接线">嵌线/接线</option>
                                <option value="压装">压装</option>
                                <option value="成品检验">成品检验</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="timing-model">产品型号</label>
                            <select id="timing-model">
                                <option value="">全部型号</option>
                                <!-- 动态填充 -->
                            </select>
                        </div>
                        <button id="calculate-timing" class="analysis-btn">计算工序时间</button>
                    </div>
                    
                    <div class="analysis-result">
                        <div id="timing-chart-container" style="height: 300px; margin-top: 20px;">
                            <canvas id="timing-chart"></canvas>
                        </div>
                        
                        <div id="timing-stats" class="stats-container">
                            <div class="stat-card">
                                <h3>平均工序时间</h3>
                                <div id="avg-time" class="stat-value">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>最短时间</h3>
                                <div id="min-time" class="stat-value">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>最长时间</h3>
                                <div id="max-time" class="stat-value">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>样本数量</h3>
                                <div id="sample-count" class="stat-value">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>异常值数量</h3>
                                <div id="outlier-count"></div>
                            </div>
                        </div>
                        
                        <table id="timing-table">
                            <thead>
                                <tr>
                                    <th data-sort="employee">员工</th>
                                    <th data-sort="process">工序</th>
                                    <th data-sort="model">产品型号</th>
                                    <th data-sort="avgTime">平均时间(小时)</th>
                                    <th data-sort="medianTime">中位数时间(小时)</th>
                                    <th data-sort="validCount">有效样本</th>
                                    <th data-sort="crossDayCount">跨天样本</th>
                                    <th data-sort="outOfRangeCount">超范围样本</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 正确引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- 将所有代码整合在一个文件中，避免引用问题 -->
    <script>
        // 全局缓存变量，用于存储已获取的数据
        let dataCache = {
            modelSeries: null,
            seriesProcesses: null,
            products: null,
            lastFetch: null
        };
        
        // 全局变量用于存储统计数据
        let allStatistics = [];
        let filteredStatistics = [];
        
        // 当前排序状态
        let currentSort = {
            column: null,
            direction: 'asc'
        };

        // 优化的数据获取函数，支持缓存和选择性获取
        async function fetchApiData(tables = ['modelSeries', 'seriesProcesses', 'products'], forceRefresh = false) {
            // API端点映射
            const apiMap = {
                modelSeries: '/api/modelSeries',
                seriesProcesses: '/api/seriesProcesses',
                products: '/api/getProductDetailsAll' // 你需要在后端实现一个返回所有产品详情的接口
            };
            // 如果有缓存且未强制刷新，则使用缓存
            if (dataCache.lastFetch && !forceRefresh) {
                const result = {};
                tables.forEach(table => {
                    if (dataCache[table]) {
                        result[table] = dataCache[table];
                    }
                });
                if (Object.keys(result).length === tables.length) {
                    return result;
                }
            }
            const result = {};
            try {
                if (tables.includes('modelSeries')) {
                    const res = await fetch(apiMap.modelSeries);
                    const json = await res.json();
                    result.modelSeries = json.data || [];
                    dataCache.modelSeries = result.modelSeries;
                }
                if (tables.includes('seriesProcesses')) {
                    const res = await fetch(apiMap.seriesProcesses);
                    const json = await res.json();
                    result.seriesProcesses = json.data || [];
                    dataCache.seriesProcesses = result.seriesProcesses;
                }
                if (tables.includes('products')) {
                    const res = await fetch(apiMap.products);
                    const json = await res.json();
                    result.products = json.data || [];
                    dataCache.products = result.products;
                }
                dataCache.lastFetch = new Date();
                return result;
            } catch (error) {
                console.error("获取数据失败:", error);
                throw error;
            }
        }
        
        // 延迟初始化应用
        window.initializeApp = function() {
            // 应用初始化代码
            console.log("页面加载完成，初始化应用...");
            
            // 定义DOM元素
            const refreshBtn = document.getElementById('refresh-btn');
            const lastUpdatedSpan = document.getElementById('last-updated');
            const loadingDiv = document.getElementById('loading');
            const statisticsTable = document.getElementById('model-statistics').querySelector('tbody');
            const tableHeader = document.getElementById('model-statistics').querySelector('thead');
            
            // 筛选相关元素
            const modelFilter = document.getElementById('modelFilter');
            const seriesFilter = document.getElementById('seriesFilter');
            const processFilter = document.getElementById('processFilter');
            const searchInput = document.getElementById('searchInput');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const clearFiltersBtn = document.getElementById('clearFilters');
            
            // 存储所有数据和筛选后的数据
            let allStatistics = [];
            let filteredStatistics = [];
            
            // 存储当前排序状态
            let currentSort = {
                column: '',
                direction: 'asc'
            };

            // 刷新按钮点击事件
            refreshBtn.addEventListener('click', function() {
                fetchProductionData(true); // 强制刷新
            });
            
            // 应用筛选按钮点击事件
            applyFiltersBtn.addEventListener('click', function() {
                applyFilters();
            });
            
            // 清除筛选按钮点击事件
            clearFiltersBtn.addEventListener('click', function() {
                clearFilters();
            });
            
            // 搜索框输入事件
            searchInput.addEventListener('input', function() {
                applyFilters();
            });
            
            // 设置表头排序事件
            tableHeader.querySelectorAll('th').forEach(headerCell => {
                headerCell.addEventListener('click', () => {
                    const sortColumn = headerCell.getAttribute('data-sort');
                    if (sortColumn) {
                        sortTable(sortColumn);
                    }
                });
            });

            // 从Supabase获取数据并处理
            async function fetchProductionData(forceRefresh = false) {
                try {
                    console.log("开始获取数据...");
                    // 显示加载中
                    loadingDiv.style.display = 'block';
                    loadingDiv.textContent = "正在连接数据库...";
                    loadingDiv.className = "loading";
                    
                    // 获取所有需要的数据（只请求一次）
                    const { modelSeries, seriesProcesses, products } = 
                        await fetchApiData(['modelSeries', 'seriesProcesses', 'products'], forceRefresh);
                    
                    if (!modelSeries || modelSeries.length === 0) {
                        throw new Error("没有获取到有效的model_series数据");
                    }
                    
                    if (!seriesProcesses || seriesProcesses.length === 0) {
                        throw new Error("没有获取到有效的series_processes数据");
                    }
                    
                    if (!products || products.length === 0) {
                        throw new Error("没有获取到有效的products数据");
                    }
                    
                    // 处理数据并展示
                    loadingDiv.textContent = "正在处理数据...";
                    allStatistics = processData(modelSeries, seriesProcesses, products);
                    
                    // 更新筛选器选项
                    updateFilterOptions(allStatistics);
                    
                    // 应用初始筛选并显示数据
                    applyFilters();
                    
                    // 保存数据，用于导出
                    window.exportData = {
                        products: products,
                        modelSeries: modelSeries,
                        seriesProcesses: seriesProcesses,
                        modelStatistics: allStatistics
                    };
                    
                    // 隐藏加载中提示
                    loadingDiv.style.display = 'none';
                    
                    // 更新最后刷新时间
                    const now = new Date();
                    lastUpdatedSpan.textContent = `最后更新: ${now.toLocaleString()}`;
                    
                    // 更新缓存状态
                    updateCacheStatus(`数据已刷新: ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('获取数据出错:', error);
                    loadingDiv.textContent = `加载失败: ${error.message}`;
                    loadingDiv.className = "loading error";
                }
            }

            // 处理数据
            function processData(modelSeries, seriesProcesses, products) {
                // 创建型号到工艺分类的映射
                const modelToSeries = {};
                modelSeries.forEach(item => {
                    modelToSeries[item.产品型号] = item.工艺分类;
                });
                
                // 创建工艺分类到工艺流程的映射
                const seriesToProcesses = {};
                seriesProcesses.forEach(item => {
                    const processNames = [];
                    // 按顺序从process_1到process_8提取工序名称
                    for (let i = 1; i <= 8; i++) {
                        const processKey = `process_${i}`;
                        if (item[processKey] && item[processKey].trim() !== '') {
                            processNames.push(item[processKey]);
                        }
                    }
                    seriesToProcesses[item.工艺分类] = processNames;
                });
                
                // 分组产品数据，按型号统计
                const productsByModel = {};
                products.forEach(product => {
                    const model = product.产品型号;
                    if (!model) return; // 跳过没有型号的产品
                    
                    if (!productsByModel[model]) {
                        productsByModel[model] = [];
                    }
                    productsByModel[model].push(product);
                });
                
                // 生成统计结果
                const statistics = [];
                
                // 所有可能的工序及其对应的时间字段
                const allProcesses = ['绕线', '嵌线', '接线', '嵌线/接线', '压装', '半成品检验', '浸漆', '车止口', '成品检验'];
                const processTimeFields = {
                    '绕线': '绕线时间',
                    '嵌线': '嵌线时间',
                    '接线': '接线时间',
                    '嵌线/接线': null, // 特殊处理：嵌线或接线完成一个即可
                    '压装': '压装时间',
                    '半成品检验': '半成品检验时间',
                    '浸漆': '浸漆时间',
                    '车止口': '车止口时间',
                    '成品检验': '成品检验时间'
                };
                
                // 特殊工序组合映射
                const processGroups = {
                    '嵌线/接线': ['嵌线', '接线']
                };

                // 创建一个用于存储在制品数据的数组
                const wipStatistics = [];
                
                for (const model in productsByModel) {
                    const products = productsByModel[model];
                    const series = modelToSeries[model];
                    
                    if (!series || !seriesToProcesses[series]) {
                        // 跳过没有对应工艺分类或工艺流程的型号
                        statistics.push({
                            model,
                            series: series || '未知',
                            processes: '未定义',
                            completedCount: 0,
                            totalCount: products.length,
                            completionRate: '0%',
                            completionRateValue: 0, // 用于排序
                            processCounts: {}, // 各工序完成数量
                            processTimestamps: {} // 各工序的完成时间戳
                        });
                        continue;
                    }
                    
                    // 获取工艺流程
                    const processes = seriesToProcesses[series];
                    
                    // 初始化各工序计数
                    const processCounts = {};
                    const processTimestamps = {};
                    allProcesses.forEach(process => {
                        processCounts[process] = 0;
                        processTimestamps[process] = [];
                    });
                    
                    // 初始化各工序阶段统计
                    const processStageCount = {};
                    allProcesses.forEach(process => {
                        processStageCount[process] = 0;
                    });
                    let notStartedCount = 0;
                    
                    // 计算各工序完成数量
                    products.forEach(product => {
                        // 找出该产品当前所处的工序阶段（在制品使用下一个待处理的工序）
                        let lastCompletedIndex = -1; // 最后完成的工序索引
                        
                        // 检查工艺路线中的工序完成情况
                        for (let i = 0; i < processes.length; i++) {
                            const process = processes[i];
                            
                            // 处理组合工序（如"嵌线/接线"）
                            if (processGroups[process]) {
                                const subProcesses = processGroups[process];
                                // 检查是否有任一子工序已完成
                                const completed = subProcesses.some(subProcess => {
                                    const subTimeField = processTimeFields[subProcess];
                                    return subTimeField && product[subTimeField];
                                });
                                
                                if (completed) {
                                    // 记录完成的工序索引
                                    lastCompletedIndex = i;
                                }
                            } else {
                                // 普通工序处理
                                const timeField = processTimeFields[process];
                                if (timeField && product[timeField]) {
                                    // 记录完成的工序索引
                                    lastCompletedIndex = i;
                                }
                            }
                        }
                        
                        // 确定当前工序状态
                        if (lastCompletedIndex === -1) {
                            // 未开始任何工序
                            notStartedCount++;
                        } else if (lastCompletedIndex === processes.length - 1) {
                            // 已完成所有工序，不计入在制品
                        } else {
                            // 已完成某个工序，状态应为下一工序
                            const nextProcessIndex = lastCompletedIndex + 1;
                            const nextProcess = processes[nextProcessIndex];
                            
                            if (nextProcess) {
                                processStageCount[nextProcess] = (processStageCount[nextProcess] || 0) + 1;
                            }
                        }
                        
                        // 统计各工序的完成情况 - 不需要修改这部分，仍然统计已完成的工序数
                        processes.forEach(process => {
                            // 处理组合工序情况
                            if (processGroups[process]) {
                                const subProcesses = processGroups[process];
                                // 检查是否有任一子工序已完成
                                const completed = subProcesses.some(subProcess => {
                                    const subTimeField = processTimeFields[subProcess];
                                    return subTimeField && product[subTimeField];
                                });
                                
                                if (completed) {
                                    processCounts[process]++;
                                    
                                    // 对于组合工序，记录最早完成的子工序的时间戳
                                    let earliestTimestamp = null;
                                    let completedSubProcess = null;
                                    
                                    subProcesses.forEach(subProcess => {
                                        const subTimeField = processTimeFields[subProcess];
                                        if (subTimeField && product[subTimeField]) {
                                            const timestamp = new Date(product[subTimeField]);
                                            if (!earliestTimestamp || timestamp < earliestTimestamp) {
                                                earliestTimestamp = timestamp;
                                                completedSubProcess = subProcess;
                                            }
                                        }
                                    });
                                    
                                    if (earliestTimestamp) {
                                        processTimestamps[process].push({
                                            timestamp: earliestTimestamp,
                                            productCode: product.产品编码,
                                            subProcess: completedSubProcess // 记录实际完成的子工序
                                        });
                                    }
                                }
                            } else {
                                // 普通工序处理
                                const timeField = processTimeFields[process];
                                if (timeField && product[timeField]) {
                                    processCounts[process]++;
                                    
                                    // 存储完成时间戳
                                    processTimestamps[process].push({
                                        timestamp: product[timeField],
                                        productCode: product.产品编码
                                    });
                                }
                            }
                        });
                    });
                    
                    // 计算完成率（以最后一道工序为准）
                    const lastProcess = processes[processes.length - 1];
                    const completedCount = processCounts[lastProcess] || 0;
                    const completionRateValue = products.length > 0 
                        ? (completedCount / products.length) * 100 
                        : 0;
                    const completionRate = completionRateValue.toFixed(2) + '%';
                    
                    // 添加到统计结果
                    statistics.push({
                        model,
                        series,
                        processes: processes.join(' -> '),
                        completedCount,
                        totalCount: products.length,
                        completionRate,
                        completionRateValue,
                        processCounts,
                        processTimestamps,
                        processGroups // 添加工序组关系信息
                    });
                    
                    // 添加到在制品统计
                    wipStatistics.push({
                        model,
                        series,
                        totalCount: products.length,
                        notStarted: notStartedCount,
                        processStages: processStageCount,
                        processList: processes // 保存该型号的工序列表
                    });
                }
                
                // 将在制品数据添加到全局变量用于筛选
                window.wipStatistics = wipStatistics;
                
                return statistics;
            }
            
            // 更新筛选器选项
            function updateFilterOptions(statistics) {
                // 清空现有选项（保留"全部"选项）
                while (modelFilter.options.length > 1) {
                    modelFilter.remove(1);
                }
                while (seriesFilter.options.length > 1) {
                    seriesFilter.remove(1);
                }
                
                // 收集唯一的型号和工艺分类
                const uniqueModels = new Set();
                const uniqueSeries = new Set();
                
                statistics.forEach(stat => {
                    uniqueModels.add(stat.model);
                    uniqueSeries.add(stat.series);
                });
                
                // 添加型号选项
                [...uniqueModels].sort().forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelFilter.appendChild(option);
                });
                
                // 添加工艺分类选项
                [...uniqueSeries].sort().forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    seriesFilter.appendChild(option);
                });
            }
            
            // 应用筛选
            function applyFilters() {
                // 获取活动标签页
                const activeTabButton = document.querySelector('.tab-button.active');
                const activeTab = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'products';
                
                // 获取筛选条件
                const selectedModel = document.getElementById('modelFilter').value;
                const selectedSeries = document.getElementById('seriesFilter').value;
                const selectedProcess = document.getElementById('processFilter').value;
                const searchTerm = document.getElementById('searchInput').value;
                
                // 日期筛选
                const startDateInput = document.getElementById('date-start').value;
                const endDateInput = document.getElementById('date-end').value;
                
                let startDate = null;
                let endDate = null;
                
                if (startDateInput) {
                    startDate = new Date(startDateInput);
                    startDate.setHours(0, 0, 0, 0);
                }
                
                if (endDateInput) {
                    endDate = new Date(endDateInput);
                    endDate.setHours(23, 59, 59, 999);
                }
                
                // 根据当前活动标签页应用不同的筛选
                if (activeTab === 'products') {
                    // 应用产品型号视图筛选
                    filterModelStatistics(selectedModel, selectedSeries, selectedProcess, searchTerm, startDate, endDate);
                } else if (activeTab === 'employees') {
                    // 应用员工视图筛选
                    filterEmployeeStatistics(startDate, endDate, searchTerm, selectedProcess);
                } else if (activeTab === 'wip') {
                    // 应用在制品视图筛选
                    filterWipStatistics(startDate, endDate, searchTerm, selectedProcess);
                }
            }
            
            // 添加产品型号视图筛选函数
            function filterModelStatistics(selectedModel, selectedSeries, selectedProcess, searchTerm, startDate, endDate) {
                if (!allStatistics) return;
                
                // 重置筛选后的数据
                filteredStatistics = JSON.parse(JSON.stringify(allStatistics));
                
                // 应用型号筛选
                if (selectedModel) {
                    filteredStatistics = filteredStatistics.filter(stat => stat.model === selectedModel);
                }
                
                // 应用工艺分类筛选
                if (selectedSeries) {
                    filteredStatistics = filteredStatistics.filter(stat => stat.series === selectedSeries);
                }
                
                // 应用工序筛选
                if (selectedProcess) {
                    filteredStatistics = filteredStatistics.filter(stat => {
                        // 检查该型号是否有该工序
                        if (!stat.processCounts) {
                            return false;
                        }
                        
                        // 处理组合工序情况
                        if (stat.processGroups && stat.processGroups[selectedProcess]) {
                            // 对于组合工序，检查是否有任一子工序存在
                            const subProcesses = stat.processGroups[selectedProcess];
                            const hasAnySubProcess = subProcesses.some(subProcess => 
                                stat.processCounts && typeof stat.processCounts[subProcess] !== 'undefined'
                            );
                            
                            if (hasAnySubProcess) {
                                // 如果存在组合工序，添加特殊筛选信息
                                stat.processFilterInfo = `${selectedProcess}: ${stat.processCounts[selectedProcess] || 0}`;
                                return true;
                            }
                            return false;
                        } 
                        
                        // 常规工序处理
                        if (!stat.processCounts[selectedProcess]) {
                            return false;
                        }
                        
                        // 添加工序筛选信息
                        stat.processFilterInfo = `${selectedProcess}: ${stat.processCounts[selectedProcess]}`;
                        
                        // 只筛选有该工序时间戳的产品型号
                        return true;
                    });
                    
                    // 修改显示的完成数量为选定工序的完成数量
                    filteredStatistics.forEach(stat => {
                        if (stat.processCounts && stat.processCounts[selectedProcess]) {
                            stat.completedCount = stat.processCounts[selectedProcess];
                            stat.completionRate = stat.totalCount > 0 
                                ? ((stat.completedCount / stat.totalCount) * 100).toFixed(2) + '%' 
                                : '0.00%';
                        }
                    });
                } else {
                    // 如果没有选择工序，清除工序筛选信息
                    filteredStatistics.forEach(stat => {
                        stat.processFilterInfo = '';
                    });
                }
                
                // 应用搜索筛选
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    filteredStatistics = filteredStatistics.filter(stat => {
                        return (stat.model && stat.model.toLowerCase().includes(searchLower)) ||
                               (stat.series && stat.series.toLowerCase().includes(searchLower));
                    });
                }
                
                // 应用日期筛选
                if (startDate || endDate) {
                    filteredStatistics = filteredStatistics.filter(stat => {
                        // 如果选择了工序，使用该工序的时间戳筛选
                        const processToCheck = selectedProcess || Object.keys(stat.processCounts || {}).pop();
                        
                        if (!processToCheck || !stat.processTimestamps) {
                            return false;
                        }
                        
                        // 处理组合工序情况
                        if (stat.processGroups && stat.processGroups[processToCheck]) {
                            // 组合工序特殊处理：检查任一子工序是否有符合日期条件的记录
                            if (!stat.processTimestamps[processToCheck]) {
                                return false;
                            }
                            
                            return stat.processTimestamps[processToCheck].some(item => {
                                const timestamp = new Date(item.timestamp);
                                return (!startDate || timestamp >= startDate) && 
                                       (!endDate || timestamp <= endDate);
                            });
                        }
                        
                        // 常规工序处理
                        if (!stat.processTimestamps[processToCheck]) {
                            return false;
                        }
                        
                        // 检查所选工序是否在日期范围内有完成记录
                        return stat.processTimestamps[processToCheck].some(item => {
                            const timestamp = new Date(item.timestamp);
                            return (!startDate || timestamp >= startDate) && 
                                   (!endDate || timestamp <= endDate);
                        });
                    });
                    
                    // 如果应用了日期筛选，重新计算各工序完成数量
                    if (selectedProcess) {
                        filteredStatistics.forEach(stat => {
                            if (stat.processTimestamps && stat.processTimestamps[selectedProcess]) {
                                // 计算日期范围内完成的数量
                                const inRangeCount = stat.processTimestamps[selectedProcess].filter(item => {
                                    const timestamp = new Date(item.timestamp);
                                    return (!startDate || timestamp >= startDate) && 
                                           (!endDate || timestamp <= endDate);
                                }).length;
                                
                                stat.completedCount = inRangeCount;
                                stat.completionRate = stat.totalCount > 0 
                                    ? ((inRangeCount / stat.totalCount) * 100).toFixed(2) + '%' 
                                    : '0.00%';
                                    
                                // 更新工序筛选信息
                                const dateRangeInfo = [];
                                if (startDate) dateRangeInfo.push(startDate.toLocaleDateString());
                                if (endDate) dateRangeInfo.push(endDate.toLocaleDateString());
                                
                                // 添加子工序信息（对于组合工序）
                                if (stat.processGroups && stat.processGroups[selectedProcess]) {
                                    const subProcessCounts = {};
                                    stat.processTimestamps[selectedProcess].forEach(item => {
                                        if (item.subProcess) {
                                            subProcessCounts[item.subProcess] = (subProcessCounts[item.subProcess] || 0) + 1;
                                        }
                                    });
                                    
                                    const subProcessInfo = Object.entries(subProcessCounts)
                                        .map(([subProcess, count]) => `${subProcess}:${count}`)
                                        .join('/');
                                    
                                    stat.processFilterInfo = `${selectedProcess}(${subProcessInfo}): ${inRangeCount} (${dateRangeInfo.join(' - ')})`;
                                } else {
                                    stat.processFilterInfo = `${selectedProcess}: ${inRangeCount} (${dateRangeInfo.join(' - ')})`;
                                }
                            }
                        });
                    }
                }
                
                // 应用当前排序
                if (currentSort.column) {
                    sortTableData(currentSort.column, currentSort.direction);
                }
                
                // 更新显示
                displayStatistics(filteredStatistics);
            }
            
            // 清除筛选
            function clearFilters() {
                modelFilter.value = '';
                seriesFilter.value = '';
                processFilter.value = '';
                searchInput.value = '';
                document.getElementById('date-start').value = '';
                document.getElementById('date-end').value = '';
                
                // 重置到所有数据
                filteredStatistics = JSON.parse(JSON.stringify(allStatistics));
                filteredStatistics.forEach(stat => {
                    stat.processFilterInfo = '';
                });
                
                // 应用当前排序
                if (currentSort.column) {
                    sortTableData(currentSort.column, currentSort.direction);
                }
                
                // 更新表格显示
                displayStatistics(filteredStatistics);
                
                // 如果员工标签页是活动的，重置员工视图
                const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
                if (activeTab === 'employees') {
                    filterEmployeeStatistics(null, null, '', null);
                }
            }
            
            // 排序表格
            function sortTable(column) {
                // 更新排序方向
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                
                // 应用排序
                sortTableData(column, currentSort.direction);
                
                // 更新表格显示
                displayStatistics(filteredStatistics);
                
                // 更新表头排序指示器
                updateSortIndicators(column, currentSort.direction);
            }
            
            // 排序数据
            function sortTableData(column, direction) {
                filteredStatistics.sort((a, b) => {
                    let valueA, valueB;
                    
                    // 根据列提取排序值
                    switch(column) {
                        case 'model':
                            valueA = a.model || '';
                            valueB = b.model || '';
                            break;
                        case 'series':
                            valueA = a.series || '';
                            valueB = b.series || '';
                            break;
                        case 'completedCount':
                            valueA = a.completedCount || 0;
                            valueB = b.completedCount || 0;
                            break;
                        case 'completionRate':
                            valueA = a.completionRateValue || 0;
                            valueB = b.completionRateValue || 0;
                            break;
                        default:
                            // 如果是工序特定的排序
                            if (column.startsWith('process-')) {
                                const processName = column.substring(8);
                                valueA = (a.processCounts && a.processCounts[processName]) || 0;
                                valueB = (b.processCounts && b.processCounts[processName]) || 0;
                            } else {
                                valueA = a[column] || 0;
                                valueB = b[column] || 0;
                            }
                    }
                    
                    // 比较值
                    if (typeof valueA === 'string' && typeof valueB === 'string') {
                        return direction === 'asc' 
                            ? valueA.localeCompare(valueB) 
                            : valueB.localeCompare(valueA);
                    } else {
                        return direction === 'asc' 
                            ? valueA - valueB 
                            : valueB - valueA;
                    }
                });
            }
            
            // 更新排序指示器
            function updateSortIndicators(column, direction) {
                // 移除所有列的排序指示器
                tableHeader.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                // 添加当前排序列的指示器
                const currentTh = tableHeader.querySelector(`th[data-sort="${column}"]`);
                if (currentTh) {
                    currentTh.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            }
            
            // 显示产品型号统计
            function displayStatistics(statistics) {
                const tableBody = document.getElementById('model-statistics').querySelector('tbody');
                tableBody.innerHTML = '';
                
                if (!statistics || statistics.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">没有找到符合条件的数据</td></tr>';
                    return;
                }
                
                statistics.forEach(stat => {
                    const row = document.createElement('tr');
                    
                    const modelCell = document.createElement('td');
                    modelCell.textContent = stat.model;
                    row.appendChild(modelCell);
                    
                    const seriesCell = document.createElement('td');
                    seriesCell.textContent = stat.series;
                    row.appendChild(seriesCell);
                    
                    const completedCell = document.createElement('td');
                    // 如果有工序筛选信息，显示该工序的完成信息
                    if (stat.processFilterInfo) {
                        completedCell.textContent = `${stat.completedCount} (${stat.processFilterInfo})`;
                    } else {
                        completedCell.textContent = stat.completedCount;
                    }
                    row.appendChild(completedCell);
                    
                    const rateCell = document.createElement('td');
                    rateCell.textContent = stat.completionRate;
                    
                    // 根据完成率添加不同的颜色
                    const percentage = parseFloat(stat.completionRate);
                    if (percentage >= 90) {
                        rateCell.style.color = '#4CAF50'; // 绿色
                    } else if (percentage >= 50) {
                        rateCell.style.color = '#FFC107'; // 黄色
                    } else {
                        rateCell.style.color = '#F44336'; // 红色
                    }
                    
                    row.appendChild(rateCell);
                    
                    tableBody.appendChild(row);
                });
            }

            // 页面加载完成后立即获取数据
            fetchProductionData();
            
            // 绑定Excel导出事件
            document.getElementById('export-excel').addEventListener('click', function() {
                if (!window.exportData) {
                    alert('没有可用的数据进行导出');
                    return;
                }
                
                const includeDetails = document.getElementById('export-details').checked;
                
                exportToExcel(window.exportData, {
                    includeDetails: includeDetails
                });
            });
            
        };

        // 加载并初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            window.initializeApp();
            
            // 标签页切换
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有标签页的active类
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    // 添加当前标签页的active类
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                    
                    // 如果切换到员工视图，加载员工数据
                    if (this.getAttribute('data-tab') === 'employees') {
                        fetchEmployeeData();
                    }
                    
                    // 如果切换到难度分析视图，初始化难度分析
                    if (this.getAttribute('data-tab') === 'difficulty') {
                        initDifficultyAnalysis();
                    }
                    
                    // 如果切换到工序时间分析视图，初始化时间分析
                    if (this.getAttribute('data-tab') === 'timing') {
                        initTimingAnalysis();
                    }
                });
            });
        });

        // 获取员工数据
        async function fetchEmployeeData() {
            try {
                // 显示加载中
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = "正在获取员工数据...";
                
                // 确保产品数据已加载
                if (!dataCache.products) {
                    await fetchApiData(['products']);
                }
                
                // 访问全局缓存中的产品数据
                const products = dataCache.products;
                
                if (!products || products.length === 0) {
                    throw new Error("没有可用的产品数据");
                }
                
                // 处理员工数据并显示
                document.getElementById('loading').textContent = "正在处理员工数据...";
                
                // 创建工序与员工字段的映射
                const processToEmployeeField = {
                    '绕线': {field: '绕线员工', timeField: '绕线时间'},
                    '嵌线': {field: '嵌线员工', timeField: '嵌线时间'},
                    '接线': {field: '接线员工', timeField: '接线时间'},
                    '压装': {field: '压装员工', timeField: '压装时间'},
                    '车止口': {field: '车止口员工', timeField: '车止口时间'},
                };
                
                // 创建员工统计数据
                const employeeStats = {};
                
                // 遍历所有产品记录
                products.forEach(product => {
                    // 遍历所有工序
                    for (const [process, fields] of Object.entries(processToEmployeeField)) {
                        const employeeField = fields.field;
                        const timeField = fields.timeField;
                        const employee = product[employeeField];
                        const timestamp = product[timeField];
                        
                        // 如果有员工和时间戳，说明该员工完成了这道工序
                        if (employee && timestamp) {
                            // 初始化该员工的统计记录
                            if (!employeeStats[employee]) {
                                employeeStats[employee] = {
                                    name: employee,
                                    processes: {},
                                    models: {},  // 按产品型号统计
                                    timestamps: [],  // 存储所有时间戳，用于计算活动情况
                                    totalCompleted: 0
                                };
                            }
                            
                            // 初始化该工序的计数
                            if (!employeeStats[employee].processes[process]) {
                                employeeStats[employee].processes[process] = 0;
                            }
                            
                            // 增加完成计数
                            employeeStats[employee].processes[process]++;
                            employeeStats[employee].totalCompleted++;
                            
                            // 记录产品型号
                            const model = product.产品型号 || '未知型号';
                            if (!employeeStats[employee].models[model]) {
                                employeeStats[employee].models[model] = 0;
                            }
                            employeeStats[employee].models[model]++;
                            
                            // 记录时间戳
                            if (timestamp) {
                                employeeStats[employee].timestamps.push({
                                    time: timestamp,
                                    process: process,
                                    productCode: product.产品编码
                                });
                            }
                        }
                    }
                });
                
                // 保存到全局变量供筛选使用
                window.employeeData = employeeStats;
                
                // 转换为数组形式便于展示
                const employeeDataArray = Object.values(employeeStats).map(stat => {
                    // 找出员工完成数量最多的工序
                    let mainProcess = '';
                    let maxCount = 0;
                    
                    for (const [process, count] of Object.entries(stat.processes)) {
                        if (count > maxCount) {
                            maxCount = count;
                            mainProcess = process;
                        }
                    }
                    
                    // 创建工序详情
                    const processDetail = Object.entries(stat.processes)
                        .map(([process, count]) => `${process}: ${count}`)
                        .join(', ');
                    
                    // 计算每天平均完成产品数（效率指数）
                    const efficiency = calculateEfficiency(stat.timestamps);
                    
                    // 获取最近活动
                    let lastActive = '无记录';
                    if (stat.timestamps.length > 0) {
                        // 按时间降序排序
                        stat.timestamps.sort((a, b) => {
                            return new Date(b.time) - new Date(a.time);
                        });
                        
                        // 获取最近的活动
                        const recentActivity = stat.timestamps[0];
                        const activityDate = new Date(recentActivity.time);
                        lastActive = `${activityDate.toLocaleDateString()} (${recentActivity.process})`;
                    }
                    
                    return {
                        employee: stat.name,
                        processType: mainProcess,
                        processDetail: processDetail,
                        completedCount: stat.totalCompleted,
                        efficiency: `${efficiency} 件/天`,
                        lastActive: lastActive,
                        // 存储原始数据，用于展示详情
                        rawData: stat
                    };
                });
                
                // 按总完成数排序
                employeeDataArray.sort((a, b) => b.completedCount - a.completedCount);
                
                // 显示员工数据
                displayEmployeeStatistics(employeeDataArray);
                
                // 隐藏加载中
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('获取员工数据失败:', error);
                document.getElementById('loading').textContent = `加载员工数据失败: ${error.message}`;
                document.getElementById('loading').className = "loading error";
            }
        }

        // 根据工序获取部门名称
        function getEmployeeDepartment(process) {
            // 简单映射工序到部门
            const processToDepartment = {
                '绕线': '绕线部',
                '嵌线': '嵌线部',
                '接线': '接线部',
                '压装': '压装部',
                '车止口': '车止口部'
            };
            
            return processToDepartment[process] || '生产部';
        }

        // 计算员工效率（每天平均完成数量）
        function calculateEfficiency(timestamps) {
            if (!timestamps || timestamps.length === 0) return '0';
            
            // 找出最早和最晚的时间戳
            let earliestDate = null;
            let latestDate = null;
            
            timestamps.forEach(activity => {
                const date = new Date(activity.time);
                if (!earliestDate || date < earliestDate) {
                    earliestDate = date;
                }
                if (!latestDate || date > latestDate) {
                    latestDate = date;
                }
            });
            
            // 计算天数差异
            const daysDiff = Math.max(1, Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24)));
            
            // 计算日均产量
            return (timestamps.length / daysDiff).toFixed(1);
        }

        // 显示员工统计
            function displayEmployeeStatistics(employeeData) {
                const tableBody = document.getElementById('employee-statistics').querySelector('tbody');
                tableBody.innerHTML = '';
                
                if (!employeeData || employeeData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">没有找到符合条件的数据</td></tr>';
                    return;
                }
                
                employeeData.forEach(employee => {
                    const row = document.createElement('tr');
                    
                    // 基本信息列
                    row.innerHTML = `
                        <td>${employee.employee}</td>
                        <td>${employee.processType}</td>
                        <td>${employee.processDetail}</td>
                        <td>${employee.completedCount}</td>
                        <td>${employee.efficiency}</td>
                        <td>${employee.lastActive}</td>
                        <td><button class="detail-btn" data-employee="${employee.employee}">详情</button></td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 添加详情按钮事件监听
                document.querySelectorAll('.detail-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const employeeName = this.getAttribute('data-employee');
                        showEmployeeDetail(employeeName, employeeData);
                    });
                });
            }
            
            // 显示员工详情模态框
            function showEmployeeDetail(employeeName, employeeData) {
                // 查找员工数据
                const employee = employeeData.find(emp => emp.employee === employeeName);
                if (!employee) return;
                
                // 填充基本信息
                document.getElementById('modal-employee-name').textContent = employee.employee;
                document.getElementById('modal-process-type').textContent = employee.processType;
                document.getElementById('modal-completed-count').textContent = employee.completedCount;
                document.getElementById('modal-efficiency').textContent = employee.efficiency;
                document.getElementById('modal-last-active').textContent = employee.lastActive;
                
                // 填充工序详情
                const processDetailDiv = document.getElementById('modal-process-detail');
                processDetailDiv.innerHTML = '';
                
                if (employee.rawData && employee.rawData.processTypes) {
                    Object.entries(employee.rawData.processTypes).forEach(([process, count]) => {
                        const badge = document.createElement('div');
                        badge.className = 'process-badge';
                        badge.textContent = `${process}: ${count}`;
                        processDetailDiv.appendChild(badge);
                    });
                }
                
                // 移除旧的产品型号汇总栏(如果存在)
                const existingModelSummary = document.getElementById('model-summary-div');
                if (existingModelSummary) {
                    existingModelSummary.remove();
                }
                
                // 添加产品型号汇总信息
                const modelSummary = {};
                if (employee.rawData && employee.rawData.timestamps) {
                    employee.rawData.timestamps.forEach(activity => {
                        // 尝试在全局产品数据中查找该产品编码对应的型号
                        let productModel = "未知";
                        if (dataCache.products) {
                            const product = dataCache.products.find(p => p.产品编码 === activity.productCode);
                            if (product && product.产品型号) {
                                productModel = product.产品型号;
                                // 统计型号数量
                                modelSummary[productModel] = (modelSummary[productModel] || 0) + 1;
                            }
                        }
                    });
                }
                
                // 显示产品型号汇总
                const modelSummaryDiv = document.createElement('div');
                modelSummaryDiv.id = 'model-summary-div'; // 添加ID便于后续识别
                modelSummaryDiv.innerHTML = '<h3>产品型号汇总</h3>';
                processDetailDiv.parentNode.insertBefore(modelSummaryDiv, processDetailDiv.nextSibling);
                
                const modelDetailDiv = document.createElement('div');
                modelDetailDiv.style.display = 'flex';
                modelDetailDiv.style.flexWrap = 'wrap';
                modelDetailDiv.style.gap = '10px';
                modelDetailDiv.style.marginBottom = '20px';
                
                // 按数量排序并显示
                Object.entries(modelSummary)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([model, count]) => {
                        const badge = document.createElement('div');
                        badge.className = 'process-badge';
                        badge.style.backgroundColor = '#e8f4fc';
                        badge.style.borderLeftColor = '#2196F3';
                        badge.textContent = `${model}: ${count}`;
                        modelDetailDiv.appendChild(badge);
                    });
                
                modelSummaryDiv.appendChild(modelDetailDiv);
                
                // 填充近期活动，添加产品型号列
                const recentActivitiesTable = document.getElementById('modal-recent-activities');
                const recentActivitiesHead = recentActivitiesTable.querySelector('thead');
                recentActivitiesHead.innerHTML = `
                    <tr>
                        <th>产品编码</th>
                        <th>产品型号</th>
                        <th>工序</th>
                        <th>完成时间</th>
                    </tr>
                `;
                
                const recentActivitiesBody = recentActivitiesTable.querySelector('tbody');
                recentActivitiesBody.innerHTML = '';
                
                if (employee.rawData && employee.rawData.timestamps) {
                    // 按时间降序排序
                    const sortedActivities = [...employee.rawData.timestamps].sort((a, b) => 
                        new Date(b.time) - new Date(a.time)
                    );
                    
                    // 获取当前筛选条件
                    const startDateInput = document.getElementById('date-start').value;
                    const endDateInput = document.getElementById('date-end').value;
                    const selectedProcess = document.getElementById('processFilter').value;
                    
                    let startDate = null;
                    let endDate = null;
                    
                    if (startDateInput) {
                        startDate = new Date(startDateInput);
                        startDate.setHours(0, 0, 0, 0);
                    }
                    
                    if (endDateInput) {
                        endDate = new Date(endDateInput);
                        endDate.setHours(23, 59, 59, 999);
                    }
                    
                    // 应用筛选条件
                    let filteredActivities = sortedActivities;
                    
                    // 应用工序筛选
                    if (selectedProcess) {
                        filteredActivities = filteredActivities.filter(activity => 
                            activity.process === selectedProcess
                        );
                    }
                    
                    // 应用日期筛选
                    if (startDate || endDate) {
                        filteredActivities = filteredActivities.filter(activity => {
                            const activityDate = new Date(activity.time);
                            return (!startDate || activityDate >= startDate) && 
                                   (!endDate || activityDate <= endDate);
                        });
                    }
                    
                    // 最多显示最近50条记录
                    const recentActivities = filteredActivities.slice(0, 50);
                    
                    recentActivities.forEach(activity => {
                        // 从产品编码中查找对应的型号
                        let productModel = "未知";
                        if (dataCache.products) {
                            const product = dataCache.products.find(p => p.产品编码 === activity.productCode);
                            if (product && product.产品型号) {
                                productModel = product.产品型号;
                            }
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${activity.productCode || ''}</td>
                            <td>${productModel}</td>
                            <td>${activity.process || ''}</td>
                            <td>${new Date(activity.time).toLocaleString()}</td>
                        `;
                        recentActivitiesBody.appendChild(row);
                    });
                }
                
                // 如果有条件地显示效率趋势图
                const chartContainer = document.getElementById('efficiency-chart');
                chartContainer.innerHTML = '效率趋势图功能待实现';
                
                // 显示模态框
                const modal = document.getElementById('employee-detail-modal');
                modal.style.display = 'block';
                
                // 关闭按钮事件
                const closeBtn = modal.querySelector('.close');
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                };
                
                // 点击模态框外部关闭
                window.onclick = function(event) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };
            }

        // 导出到Excel
        function exportToExcel(data, exportOptions = {}) {
            const fileName = exportOptions.fileName || '产品生产进度统计';
            
            // 创建一个新的工作簿
            const workbook = XLSX.utils.book_new();
            
            // 1. 导出产品型号视图数据
            exportModelStatistics(workbook);
            
            // 2. 导出员工汇总数据
            exportEmployeeStatistics(workbook);
            
            // 3. 导出在制品视图数据
            exportWipStatistics(workbook);
            
            // 4. 为每个员工创建单独的工作表
            if (window.employeeData) {
                exportEmployeeDetails(workbook);
            }
            
            // 5. 如果选择包含产品详情，则添加产品详情工作表
            if (exportOptions.includeDetails && data.products) {
                exportProductDetails(workbook, data.products);
            }
            
            // 导出工作簿
            XLSX.writeFile(workbook, `${fileName}.xlsx`);
        }
        
        // 新增函数：为每个员工创建单独的工作表
        function exportEmployeeDetails(workbook) {
            if (!window.employeeData) return;
            
            // 获取当前筛选条件
            const startDateInput = document.getElementById('date-start').value;
            const endDateInput = document.getElementById('date-end').value;
            const selectedProcess = document.getElementById('processFilter').value;
            
            let startDate = null;
            let endDate = null;
            
            if (startDateInput) {
                startDate = new Date(startDateInput);
                startDate.setHours(0, 0, 0, 0);
            }
            
            if (endDateInput) {
                endDate = new Date(endDateInput);
                endDate.setHours(23, 59, 59, 999);
            }
            
            // 遍历所有员工
            Object.entries(window.employeeData).forEach(([employeeName, employeeData]) => {
                // 跳过完成数量太少的员工
                if (employeeData.totalCompleted < 5) return;
                
                // 筛选该员工的时间戳
                let filteredTimestamps = [...employeeData.timestamps];
                
                // 应用工序筛选
                if (selectedProcess) {
                    filteredTimestamps = filteredTimestamps.filter(activity => 
                        activity.process === selectedProcess
                    );
                }
                
                // 应用日期筛选
                if (startDate || endDate) {
                    filteredTimestamps = filteredTimestamps.filter(activity => {
                        const activityDate = new Date(activity.time);
                        return (!startDate || activityDate >= startDate) && 
                               (!endDate || activityDate <= endDate);
                    });
                }
                
                // 如果没有符合条件的活动，跳过该员工
                if (filteredTimestamps.length === 0) return;
                
                // 按日期降序排序
                filteredTimestamps.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // 准备活动数据
                const activityData = filteredTimestamps.map(activity => {
                    // 尝试在全局产品数据中查找该产品编码对应的型号
                    let productModel = "未知";
                    if (dataCache.products) {
                        const product = dataCache.products.find(p => p.产品编码 === activity.productCode);
                        if (product && product.产品型号) {
                            productModel = product.产品型号;
                        }
                    }
                    
                    return {
                        '产品编码': activity.productCode || '',
                        '产品型号': productModel,
                        '工序': activity.process || '',
                        '完成时间': new Date(activity.time).toLocaleString()
                    };
                });
                
                // 创建工作表名称（使用员工姓名，去除特殊字符）
                const sheetName = employeeName.replace(/[\\\/\[\]\?\*]/g, '').substring(0, 30);
                
                // 只创建一个详情工作表
                if (activityData.length > 0) {
                    const activitySheet = XLSX.utils.json_to_sheet(activityData);
                    XLSX.utils.book_append_sheet(workbook, activitySheet, sheetName);
                }
            });
        }
        
        // 导出产品型号统计数据
        function exportModelStatistics(workbook) {
            if (!filteredStatistics || filteredStatistics.length === 0) return;
            
            // 准备数据
            const exportData = filteredStatistics.map(stat => {
                const row = {
                    '产品型号': stat.model,
                    '工艺分类': stat.series,
                    '完成数量': stat.completedCount,
                    '总数量': stat.totalCount,
                    '完成率': stat.completionRate
                };
                
                // 添加各工序完成数
                if (stat.processCounts) {
                    Object.entries(stat.processCounts).forEach(([process, count]) => {
                        row[`${process}完成数`] = count;
                    });
                }
                
                return row;
            });
            
            // 创建工作表
            const modelSheet = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(workbook, modelSheet, "产品型号统计");
        }
        
        // 导出员工统计数据
        function exportEmployeeStatistics(workbook) {
            // 获取当前筛选后的员工数据
            const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
            if (activeTab !== 'employees') {
                // 如果当前不在员工视图，应用当前筛选条件获取员工数据
                const selectedProcess = document.getElementById('processFilter').value;
                const searchTerm = document.getElementById('searchInput').value;
                
                // 日期筛选
                const startDateInput = document.getElementById('date-start').value;
                const endDateInput = document.getElementById('date-end').value;
                
                let startDate = null;
                let endDate = null;
                
                if (startDateInput) {
                    startDate = new Date(startDateInput);
                    startDate.setHours(0, 0, 0, 0);
                }
                
                if (endDateInput) {
                    endDate = new Date(endDateInput);
                    endDate.setHours(23, 59, 59, 999);
                }
                
                // 获取筛选后的员工数据
                if (window.employeeData) {
                    // 临时保存当前显示的筛选后数据
                    const tempData = [];
                    
                    // 应用筛选逻辑，但不更新UI
                    Object.entries(window.employeeData).forEach(([employee, data]) => {
                        // 应用搜索筛选
                        if (searchTerm && !employee.toLowerCase().includes(searchTerm.toLowerCase())) {
                            return;
                        }
                        
                        // 筛选符合条件的活动
                        let filteredTimestamps = [...data.timestamps];
                        
                        // 应用工序筛选
                        if (selectedProcess) {
                            filteredTimestamps = filteredTimestamps.filter(activity => 
                                activity.process === selectedProcess
                            );
                        }
                        
                        // 应用日期筛选
                        if (startDate || endDate) {
                            filteredTimestamps = filteredTimestamps.filter(activity => {
                                const activityDate = new Date(activity.time);
                                return (!startDate || activityDate >= startDate) && 
                                       (!endDate || activityDate <= endDate);
                            });
                        }
                        
                        // 如果没有符合条件的活动，排除此员工
                        if (filteredTimestamps.length === 0) {
                            return;
                        }
                        
                        // 创建此员工的筛选后数据
                        const employeeData = {
                            ...data,
                            timestamps: filteredTimestamps,
                            totalCount: filteredTimestamps.length,
                            processTypes: countProcessTypes(filteredTimestamps)
                        };
                        
                        // 添加到临时数据
                        tempData.push(employeeData);
                    });
                    
                    // 准备导出数据
                    const exportData = tempData.map(employee => {
                        // 找出员工完成数量最多的工序
                        let mainProcess = '';
                        let maxCount = 0;
                        
                        for (const [process, count] of Object.entries(employee.processTypes)) {
                            if (count > maxCount) {
                                maxCount = count;
                                mainProcess = process;
                            }
                        }
                        
                        // 创建工序详情
                        const processDetail = Object.entries(employee.processTypes)
                            .map(([process, count]) => `${process}: ${count}`)
                            .join(', ');
                        
                        // 计算每天平均完成产品数
                        const efficiency = calculateEfficiency(employee.timestamps);
                        
                        // 获取最近活动
                        let lastActive = '无记录';
                        if (employee.timestamps.length > 0) {
                            // 按时间降序排序
                            employee.timestamps.sort((a, b) => {
                                return new Date(b.time) - new Date(a.time);
                            });
                            
                            // 获取最近的活动
                            const recentActivity = employee.timestamps[0];
                            const activityDate = new Date(recentActivity.time);
                            lastActive = `${activityDate.toLocaleDateString()} (${recentActivity.process})`;
                        }
                        
                        return {
                            '员工姓名': employee.name,
                            '主要工序': mainProcess,
                            '工序完成详情': processDetail,
                            '完成总数': employee.totalCount,
                            '日均产量': `${efficiency} 件/天`,
                            '最近活动': lastActive
                        };
                    });
                    
                    // 创建工作表
                    const employeeSheet = XLSX.utils.json_to_sheet(exportData);
                    XLSX.utils.book_append_sheet(workbook, employeeSheet, "员工统计");
                }
            } else {
                // 如果正在查看员工视图，使用当前表格数据
                const table = document.getElementById('employee-statistics');
                const employeeSheet = XLSX.utils.table_to_sheet(table);
                XLSX.utils.book_append_sheet(workbook, employeeSheet, "员工统计");
            }
        }
        
        // 导出在制品视图数据
        function exportWipStatistics(workbook) {
            if (!window.wipStatistics) return;
            
            // 应用当前筛选条件
            const selectedModel = document.getElementById('modelFilter').value;
            const selectedSeries = document.getElementById('seriesFilter').value;
            const selectedProcess = document.getElementById('processFilter').value;
            const searchTerm = document.getElementById('searchInput').value;
            
            // 筛选在制品数据
            const filteredWip = window.wipStatistics.filter(item => {
                // 应用搜索筛选
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const modelMatch = item.model && item.model.toLowerCase().includes(searchLower);
                    const seriesMatch = item.series && item.series.toLowerCase().includes(searchLower);
                    if (!modelMatch && !seriesMatch) return false;
                }
                
                // 应用工序筛选
                if (selectedProcess && !item.processList.includes(selectedProcess)) {
                    return false;
                }
                
                // 应用型号筛选
                if (selectedModel && item.model !== selectedModel) {
                    return false;
                }
                
                // 应用工艺分类筛选
                if (selectedSeries && item.series !== selectedSeries) {
                    return false;
                }
                
                return true;
            });
            
            // 如果没有数据，返回
            if (filteredWip.length === 0) return;
            
            // 收集所有可能的工序名称，但只包含每个产品型号的工艺路线中的工序
            const allProcessNames = new Set();
            filteredWip.forEach(item => {
                if (item.processList) {
                    item.processList.forEach(process => allProcessNames.add(process));
                }
            });
            
            // 将工序名称转换为数组并排序
            const sortedProcesses = Array.from(allProcessNames).sort();
            
            // 准备导出数据
            const exportData = filteredWip.map(item => {
                const row = {
                    '产品型号': item.model,
                    '工艺分类': item.series,
                    '总数量': item.totalCount,
                    '未开始': item.notStarted
                };
                
                // 添加各工序状态，只包含该型号工艺路线中的工序
                sortedProcesses.forEach(process => {
                    // 检查此工序是否在该型号的工艺路线中
                    if (item.processList && item.processList.includes(process)) {
                        const count = item.processStages[process] || 0;
                        row[process] = count;
                    } else {
                        // 不在工艺路线中的显示为"-"
                        row[process] = "-";
                    }
                });
                
                return row;
            });
            
            // 创建工作表
            const wipSheet = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(workbook, wipSheet, "在制品统计");
        }
        
        // 导出产品详情
        function exportProductDetails(workbook, products) {
            // 最多导出1000条产品详情，避免文件过大
            const maxDetailCount = 1000;
            const productSample = products.slice(0, maxDetailCount);
            
            // 准备产品详情数据
            const productDetails = productSample.map(product => {
                return {
                    '产品编码': product.产品编码 || '',
                    '产品型号': product.产品型号 || '',
                    '绕线员工': product.绕线员工 || '',
                    '绕线时间': product.绕线时间 ? new Date(product.绕线时间).toLocaleString() : '',
                    '嵌线员工': product.嵌线员工 || '',
                    '嵌线时间': product.嵌线时间 ? new Date(product.嵌线时间).toLocaleString() : '',
                    '接线员工': product.接线员工 || '',
                    '接线时间': product.接线时间 ? new Date(product.接线时间).toLocaleString() : '',
                    '压装员工': product.压装员工 || '',
                    '压装时间': product.压装时间 ? new Date(product.压装时间).toLocaleString() : '',
                    '半成品检验员工': product.半成品检验员工 || '',
                    '半成品检验时间': product.半成品检验时间 ? new Date(product.半成品检验时间).toLocaleString() : '',
                    '浸漆员工': product.浸漆员工 || '',
                    '浸漆时间': product.浸漆时间 ? new Date(product.浸漆时间).toLocaleString() : '',
                    '车止口员工': product.车止口员工 || '',
                    '车止口时间': product.车止口时间 ? new Date(product.车止口时间).toLocaleString() : '',
                    '成品检验员工': product.成品检验员工 || '',
                    '成品检验时间': product.成品检验时间 ? new Date(product.成品检验时间).toLocaleString() : '',
                    '创建时间': product.created_at ? new Date(product.created_at).toLocaleString() : ''
                };
            });
            
            // 创建工作表
            const productSheet = XLSX.utils.json_to_sheet(productDetails);
            XLSX.utils.book_append_sheet(workbook, productSheet, "产品详情");
        }
        
        // 添加更新缓存状态的函数
        function updateCacheStatus(message) {
            const cacheStatusEl = document.getElementById('cache-status');
            if (cacheStatusEl) {
                cacheStatusEl.textContent = `缓存状态: ${message}`;
                cacheStatusEl.style.color = "#666"; // 重置颜色
            }
        }

        // 添加员工视图筛选函数
        function filterEmployeeStatistics(startDate, endDate, searchTerm, process) {
            if (!window.employeeData) return;
            
            const filteredEmployees = {};
            
            // 遍历所有员工
            Object.entries(window.employeeData).forEach(([employee, data]) => {
                // 应用搜索筛选
                if (searchTerm && !employee.toLowerCase().includes(searchTerm.toLowerCase())) {
                    return;
                }
                
                // 筛选符合条件的活动
                let filteredTimestamps = [...data.timestamps];
                
                // 应用工序筛选
                if (process) {
                    filteredTimestamps = filteredTimestamps.filter(activity => 
                        activity.process === process
                    );
                }
                
                // 应用日期筛选
                if (startDate || endDate) {
                    filteredTimestamps = filteredTimestamps.filter(activity => {
                        const activityDate = new Date(activity.time);
                        return (!startDate || activityDate >= startDate) && 
                               (!endDate || activityDate <= endDate);
                    });
                }
                
                // 如果没有符合条件的活动，排除此员工
                if (filteredTimestamps.length === 0) {
                    return;
                }
                
                // 创建此员工的筛选后数据
                filteredEmployees[employee] = {
                    ...data,
                    timestamps: filteredTimestamps,
                    // 重新计算此日期范围内的统计信息
                    totalCount: filteredTimestamps.length,
                    processTypes: countProcessTypes(filteredTimestamps)
                };
            });
            
            // 将对象转换为数组，与fetchEmployeeData函数中的处理方式相同
            const employeeDataArray = Object.values(filteredEmployees).map(stat => {
                // 找出员工完成数量最多的工序
                let mainProcess = '';
                let maxCount = 0;
                
                for (const [process, count] of Object.entries(stat.processTypes)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mainProcess = process;
                    }
                }
                
                // 创建工序详情
                const processDetail = Object.entries(stat.processTypes)
                    .map(([process, count]) => `${process}: ${count}`)
                    .join(', ');
                
                // 计算每天平均完成产品数（效率指数）
                const efficiency = calculateEfficiency(stat.timestamps);
                
                // 获取最近活动
                let lastActive = '无记录';
                if (stat.timestamps.length > 0) {
                    // 按时间降序排序
                    stat.timestamps.sort((a, b) => {
                        return new Date(b.time) - new Date(a.time);
                    });
                    
                    // 获取最近的活动
                    const recentActivity = stat.timestamps[0];
                    const activityDate = new Date(recentActivity.time);
                    lastActive = `${activityDate.toLocaleDateString()} (${recentActivity.process})`;
                }
                
                return {
                    employee: stat.name,
                    processType: mainProcess,
                    processDetail: processDetail,
                    completedCount: stat.totalCount,
                    efficiency: `${efficiency} 件/天`,
                    lastActive: lastActive,
                    // 存储原始数据，用于展示详情
                    rawData: stat
                };
            });
            
            // 按总完成数排序
            employeeDataArray.sort((a, b) => b.completedCount - a.completedCount);
            
            // 更新员工表格，传递数组而不是对象
            displayEmployeeStatistics(employeeDataArray);
        }

        // 辅助函数：计算工序类型数量
        function countProcessTypes(timestamps) {
            const counts = {};
            timestamps.forEach(activity => {
                counts[activity.process] = (counts[activity.process] || 0) + 1;
            });
            return counts;
        }

        // 修改标签页切换逻辑，添加筛选同步
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有active类
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // 添加active类到当前按钮和对应面板
                    this.classList.add('active');
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // 应用筛选条件到新激活的标签页
                    applyFilters();
                });
            });
        }

        // 添加在制品视图筛选函数
        function filterWipStatistics(startDate, endDate, searchTerm, selectedProcess) {
            if (!window.wipStatistics) return;
            
            // 筛选在制品数据
            const filtered = window.wipStatistics.filter(item => {
                // 应用搜索筛选
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const modelMatch = item.model && item.model.toLowerCase().includes(searchLower);
                    const seriesMatch = item.series && item.series.toLowerCase().includes(searchLower);
                    if (!modelMatch && !seriesMatch) return false;
                }
                
                // 应用工序筛选
                if (selectedProcess && !item.processList.includes(selectedProcess)) {
                    return false;
                }
                
                // 应用型号筛选
                const selectedModel = document.getElementById('modelFilter').value;
                if (selectedModel && item.model !== selectedModel) {
                    return false;
                }
                
                // 应用工艺分类筛选
                const selectedSeries = document.getElementById('seriesFilter').value;
                if (selectedSeries && item.series !== selectedSeries) {
                    return false;
                }
                
                return true;
            });
            
            // 显示筛选后的数据
            displayWipStatistics(filtered);
        }

        // 在制品视图相关函数
        function displayWipStatistics(statistics) {
            const tableBody = document.getElementById('wip-statistics').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (!statistics || statistics.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">没有找到符合条件的数据</td></tr>';
                return;
            }
            
            // 收集所有可能的工序名称，但只包含每个产品型号的工艺路线中的工序
            const allProcesses = new Set();
            statistics.forEach(item => {
                if (item.processList) {
                    item.processList.forEach(process => allProcesses.add(process));
                }
            });
            
            // 更新表头，添加工序列
            const headerRow = document.getElementById('wip-statistics').querySelector('thead tr');
            
            // 先清除所有工序列（保留基本列）
            while (headerRow.children.length > 4) {
                headerRow.removeChild(headerRow.lastChild);
            }
            
            // 添加工序表头
            allProcesses.forEach(process => {
                const th = document.createElement('th');
                th.textContent = process;
                th.setAttribute('data-sort', `process-${process}`);
                headerRow.appendChild(th);
            });
            
            // 显示数据行
            statistics.forEach(item => {
                const row = document.createElement('tr');
                
                // 添加基本信息
                row.innerHTML = `
                    <td>${item.model}</td>
                    <td>${item.series}</td>
                    <td>${item.totalCount}</td>
                    <td>${item.notStarted}</td>
                `;
                
                // 添加各工序状态，只显示数量不显示百分比
                // 只显示该型号工艺路线中的工序
                allProcesses.forEach(process => {
                    const cell = document.createElement('td');
                    
                    // 检查此工序是否在该型号的工艺路线中
                    if (item.processList && item.processList.includes(process)) {
                        const count = item.processStages[process] || 0;
                        cell.textContent = count;
                    } else {
                        // 不在工艺路线中的显示为"-"
                        cell.textContent = "-";
                        cell.style.color = "#ccc";
                    }
                    
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
        }

        // 功能10：产品型号难度系数分析
        let difficultyChart = null;
        function initDifficultyAnalysis() {
            // 确保数据已加载
            if (!dataCache.products || !dataCache.modelSeries || !dataCache.seriesProcesses) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = "正在加载数据，请稍候...";
                fetchApiData(['products', 'modelSeries', 'seriesProcesses']).then(() => {
                    document.getElementById('loading').style.display = 'none';
                    calculateDifficultyIndex();
                });
                return;
            }
            
            // 绑定计算按钮事件
            document.getElementById('calculate-difficulty').addEventListener('click', calculateDifficultyIndex);
            
            // 绑定指标切换事件
            document.getElementById('diff-metric').addEventListener('change', calculateDifficultyIndex);
        }
        
        // 计算难度系数
        function calculateDifficultyIndex() {
            const products = dataCache.products;
            const modelSeries = dataCache.modelSeries;
            const seriesProcesses = dataCache.seriesProcesses;
            
            if (!products || products.length === 0) {
                alert('没有可用的产品数据');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = "正在计算难度系数...";
            
            // 获取选定的难度评估指标
            const diffMetric = document.getElementById('diff-metric').value;
            
            // 创建产品型号到工艺分类的映射
            const modelToSeries = {};
            modelSeries.forEach(item => {
                modelToSeries[item.产品型号] = item.工艺分类;
            });
            
            // 创建工艺分类到工序的映射
            const seriesToProcesses = {};
            seriesProcesses.forEach(item => {
                const processes = [];
                for (let i = 1; i <= 8; i++) {
                    if (item[`process_${i}`]) {
                        processes.push(item[`process_${i}`]);
                    }
                }
                seriesToProcesses[item.工艺分类] = processes;
            });
            
            // 所有可能的工序及其对应的时间字段
            const processTimeFields = {
                '绕线': '绕线时间',
                '嵌线': '嵌线时间',
                '接线': '接线时间',
                '压装': '压装时间',
                '半成品检验': '半成品检验时间',
                '浸漆': '浸漆时间',
                '车止口': '车止口时间',
                '成品检验': '成品检验时间'
            };
            
            // 按产品型号分组
            const productsByModel = {};
            products.forEach(product => {
                if (!product.产品型号) return;
                
                if (!productsByModel[product.产品型号]) {
                    productsByModel[product.产品型号] = [];
                }
                productsByModel[product.产品型号].push(product);
            });
            
            // 计算每个型号的平均生产时间
            const modelDifficulty = [];
            
            Object.entries(productsByModel).forEach(([model, modelProducts]) => {
                const series = modelToSeries[model] || '未知';
                const processes = seriesToProcesses[series] || [];
                
                // 跳过没有定义工序的型号
                if (processes.length === 0) return;
                
                // 完成所有工序的产品
                const completedProducts = modelProducts.filter(product => {
                    if (!processes.length) return false;
                    const lastProcess = processes[processes.length - 1];
                    const lastTimeField = processTimeFields[lastProcess];
                    return lastTimeField && product[lastTimeField];
                });
                
                // 如果没有完成的产品，跳过
                if (completedProducts.length === 0) return;
                
                // 计算每个完成的产品的生产时间
                const productionTimes = [];
                const processTimes = {}; // 每个工序的时间
                
                completedProducts.forEach(product => {
                    let firstTime = null;
                    let lastTime = null;
                    
                    // 初始化工序时间
                    processes.forEach(process => {
                        if (!processTimes[process]) {
                            processTimes[process] = [];
                        }
                    });
                    
                    // 计算相邻工序之间的时间差
                    for (let i = 0; i < processes.length; i++) {
                        const currentProcess = processes[i];
                        const currentTimeField = processTimeFields[currentProcess];
                        
                        if (!currentTimeField || !product[currentTimeField]) continue;
                        
                        const currentTime = new Date(product[currentTimeField]);
                        
                        // 记录第一个工序时间
                        if (firstTime === null) {
                            firstTime = currentTime;
                        }
                        
                        // 上一个工序时间
                        const prevProcess = i > 0 ? processes[i-1] : null;
                        const prevTimeField = prevProcess ? processTimeFields[prevProcess] : null;
                        
                        if (prevProcess && prevTimeField && product[prevTimeField]) {
                            const prevTime = new Date(product[prevTimeField]);
                            // 计算工序间的时间差（小时）
                            const processTime = (currentTime - prevTime) / (1000 * 60 * 60);
                            
                            // 排除异常大的间隔（如隔天）
                            if (processTime > 0 && processTime < 24) {
                                processTimes[currentProcess].push(processTime);
                            }
                        }
                        
                        // 更新最后一个工序时间
                        lastTime = currentTime;
                    }
                    
                    // 计算总生产时间（小时）
                    if (firstTime && lastTime) {
                        const totalTime = (lastTime - firstTime) / (1000 * 60 * 60);
                        // 排除异常大的总时间（如跨越多天）
                        if (totalTime > 0 && totalTime < 80) { // 允许最多80小时（约3天多）
                            productionTimes.push(totalTime);
                        }
                    }
                });
                
                // 计算平均生产时间
                let avgProductionTime = 0;
                let difficultyValue = 0;
                
                if (diffMetric === 'totalTime') {
                    // 使用总生产时间作为难度指标
                    avgProductionTime = productionTimes.reduce((sum, time) => sum + time, 0) / productionTimes.length;
                    difficultyValue = avgProductionTime;
                } 
                else if (diffMetric === 'processTime') {
                    // 使用平均工序时间作为难度指标
                    let totalProcessTime = 0;
                    let processCount = 0;
                    
                    Object.values(processTimes).forEach(times => {
                        if (times.length > 0) {
                            totalProcessTime += times.reduce((sum, time) => sum + time, 0);
                            processCount += times.length;
                        }
                    });
                    
                    avgProductionTime = totalProcessTime / processCount || 0;
                    difficultyValue = avgProductionTime;
                }
                else if (diffMetric === 'cycleTime') {
                    // 使用生产周期（从第一道工序到最后一道的时间）作为难度指标
                    avgProductionTime = productionTimes.reduce((sum, time) => sum + time, 0) / productionTimes.length;
                    difficultyValue = avgProductionTime / processes.length; // 平均每道工序的时间
                }
                
                // 添加到难度列表
                modelDifficulty.push({
                    model,
                    series,
                    avgProductionTime: avgProductionTime.toFixed(2),
                    difficultyValue,
                    sampleCount: completedProducts.length,
                    processCount: processes.length,
                    processes: processes.join(' -> ')
                });
            });
            
            // 按难度值排序
            modelDifficulty.sort((a, b) => b.difficultyValue - a.difficultyValue);
            
            // 计算难度系数（相对值）
            if (modelDifficulty.length > 0) {
                const maxDifficulty = modelDifficulty[0].difficultyValue;
                modelDifficulty.forEach(item => {
                    item.difficultyIndex = ((item.difficultyValue / maxDifficulty) * 100).toFixed(0);
                });
            }
            
            // 显示难度表格
            displayDifficultyTable(modelDifficulty);
            
            // 显示难度图表
            displayDifficultyChart(modelDifficulty);
            
            document.getElementById('loading').style.display = 'none';
        }
        
        // 显示难度表格
        function displayDifficultyTable(modelDifficulty) {
            const tableBody = document.getElementById('difficulty-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (modelDifficulty.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">没有足够的数据计算难度系数</td></tr>';
                return;
            }
            
            modelDifficulty.forEach(item => {
                const row = document.createElement('tr');
                
                // 根据难度系数添加颜色
                let difficultyClass = '';
                const diffIndex = parseInt(item.difficultyIndex);
                if (diffIndex >= 80) {
                    difficultyClass = 'difficulty-high';
                } else if (diffIndex >= 40) {
                    difficultyClass = 'difficulty-medium';
                } else {
                    difficultyClass = 'difficulty-low';
                }
                
                row.innerHTML = `
                    <td>${item.model}</td>
                    <td>${item.series}</td>
                    <td>${item.avgProductionTime} 小时</td>
                    <td class="${difficultyClass}">${item.difficultyIndex}</td>
                    <td>${item.sampleCount}</td>
                    <td>${item.processCount}</td>
                    <td><button class="detail-btn" data-model="${item.model}">详情</button></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 添加详情按钮事件
            document.querySelectorAll('#difficulty-table .detail-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const model = this.getAttribute('data-model');
                    // TODO: 显示详细难度分析
                    alert(`${model} 的详细难度分析功能待实现`);
                });
            });
        }
        
        // 显示难度图表
        function displayDifficultyChart(modelDifficulty) {
            const ctx = document.getElementById('difficulty-chart').getContext('2d');
            
            // 只显示前10个最难的型号
            const topModels = modelDifficulty.slice(0, 10);
            
            // 准备图表数据
            const labels = topModels.map(item => item.model);
            const difficulties = topModels.map(item => parseFloat(item.difficultyIndex));
            const times = topModels.map(item => parseFloat(item.avgProductionTime));
            
            // 如果已存在图表，销毁它
            if (difficultyChart) {
                difficultyChart.destroy();
            }
            
            // 创建新图表
            difficultyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '难度系数',
                        data: difficulties,
                        backgroundColor: difficulties.map(d => {
                            if (d >= 80) return 'rgba(255, 99, 132, 0.7)';
                            if (d >= 40) return 'rgba(255, 205, 86, 0.7)';
                            return 'rgba(75, 192, 192, 0.7)';
                        }),
                        borderColor: difficulties.map(d => {
                            if (d >= 80) return 'rgb(255, 99, 132)';
                            if (d >= 40) return 'rgb(255, 205, 86)';
                            return 'rgb(75, 192, 192)';
                        }),
                        borderWidth: 1
                    }, {
                        label: '平均生产时间 (小时)',
                        data: times,
                        type: 'line',
                        fill: false,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '难度系数'
                            }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '时间 (小时)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '产品型号难度系数分析'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `样本数量: ${topModels[index].sampleCount}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 新增功能：工序平均时间分析
        let timingChart = null;
        function initTimingAnalysis() {
            // 确保数据已加载
            if (!dataCache.products) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = "正在加载数据，请稍候...";
                fetchApiData(['products']).then(() => {
                    document.getElementById('loading').style.display = 'none';
                    prepareTimingAnalysis();
                });
                return;
            }
            
            prepareTimingAnalysis();
            
            // 绑定计算按钮事件
            document.getElementById('calculate-timing').addEventListener('click', calculateProcessTiming);
        }
        
        // 准备工序时间分析的初始化数据
        function prepareTimingAnalysis() {
            const products = dataCache.products;
            
            if (!products || products.length === 0) {
                alert('没有可用的产品数据');
                return;
            }
            
            // 收集所有员工
            const employees = new Set();
            
            // 收集所有产品型号
            const models = new Set();
            
            // 工序到员工字段的映射
            const processToEmployeeField = {
                '绕线': '绕线员工',
                '嵌线': '嵌线员工',
                '接线': '接线员工',
                '压装': '压装员工',
                '车止口': '车止口员工'
            };
            
            // 遍历产品，收集员工和型号
            products.forEach(product => {
                // 添加产品型号
                if (product.产品型号) {
                    models.add(product.产品型号);
                }
                
                // 添加各工序员工
                Object.values(processToEmployeeField).forEach(field => {
                    if (product[field]) {
                        employees.add(product[field]);
                    }
                });
            });
            
            // 更新员工选择下拉框
            const employeeSelect = document.getElementById('timing-employee');
            // 清空现有选项（保留"全部"选项）
            while (employeeSelect.options.length > 1) {
                employeeSelect.remove(1);
            }
            
            // 添加员工选项
            [...employees].sort().forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeSelect.appendChild(option);
            });
            
            // 更新产品型号选择下拉框
            const modelSelect = document.getElementById('timing-model');
            // 清空现有选项（保留"全部"选项）
            while (modelSelect.options.length > 1) {
                modelSelect.remove(1);
            }
            
            // 添加产品型号选项
            [...models].sort().forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }
        
        // 计算工序平均时间
        function calculateProcessTiming() {
            const products = dataCache.products;
            
            if (!products || products.length === 0) {
                alert('没有可用的产品数据');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = "正在计算工序时间...";
            
            // 获取选定的筛选条件
            const selectedEmployee = document.getElementById('timing-employee').value;
            const selectedProcess = document.getElementById('timing-process').value;
            const selectedModel = document.getElementById('timing-model').value;
            
            // 如果没有选择工序，提示用户
            if (!selectedProcess) {
                alert('请选择要分析的工序');
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            // 工序到员工字段和时间字段的映射
            const processFields = {
                '绕线': {employeeField: '绕线员工', timeField: '绕线时间'},
                '嵌线': {employeeField: '嵌线员工', timeField: '嵌线时间'},
                '接线': {employeeField: '接线员工', timeField: '接线时间'},
                '压装': {employeeField: '压装员工', timeField: '压装时间'},
                '车止口': {employeeField: '车止口员工', timeField: '车止口时间'}
            };
            
            // 获取选定工序的字段
            const processInfo = processFields[selectedProcess];
            if (!processInfo) {
                alert('未找到该工序的字段定义');
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            // 首先按员工分组，获取每个员工按时间排序的工序记录
            const productsByEmployee = {};
            
            products.forEach(product => {
                // 检查是否有员工和时间记录
                const employee = product[processInfo.employeeField];
                const timestamp = product[processInfo.timeField];
                
                if (!employee || !timestamp) return;
                
                // 应用员工筛选
                if (selectedEmployee && employee !== selectedEmployee) {
                    return;
                }
                
                // 应用产品型号筛选 - 不过滤掉其他型号，而是在统计阶段处理
                // 因为需要连续的产品记录计算时间差
                
                if (!productsByEmployee[employee]) {
                    productsByEmployee[employee] = [];
                }
                
                productsByEmployee[employee].push({
                    productCode: product.产品编码,
                    model: product.产品型号 || '未知型号',
                    timestamp: new Date(timestamp),
                    employee: employee
                });
            });
            
            // 用于存储每个型号的样本数据
            const samplesByModel = {};
            
            // 处理每个员工的连续产品记录
            Object.entries(productsByEmployee).forEach(([employee, employeeProducts]) => {
                // 按时间戳排序
                employeeProducts.sort((a, b) => a.timestamp - b.timestamp);
                
                // 计算连续产品之间的时间差
                for (let i = 1; i < employeeProducts.length; i++) {
                    const prevProduct = employeeProducts[i-1];
                    const currProduct = employeeProducts[i];
                    
                    // 计算时间差（秒）
                    const timeDiff = (currProduct.timestamp - prevProduct.timestamp) / 1000;
                    
                    // 检查是否为跨天样本
                    const prevDate = new Date(prevProduct.timestamp);
                    const currDate = new Date(currProduct.timestamp);
                    const isSameDay = 
                        prevDate.getFullYear() === currDate.getFullYear() &&
                        prevDate.getMonth() === currDate.getMonth() &&
                        prevDate.getDate() === currDate.getDate();
                    
                    // 创建样本对象 - 重要：样本属于前一个产品的型号
                    const prevModel = prevProduct.model;
                    
                    // 初始化该型号的样本数组
                    if (!samplesByModel[prevModel]) {
                        samplesByModel[prevModel] = [];
                    }
                    
                    // 应用产品型号筛选 - 只在这里筛选
                    if (selectedModel && prevModel !== selectedModel) {
                        continue;
                    }
                    
                    // 创建样本对象
                    const sample = {
                        employee,
                        model: prevModel,
                        timeDiff,
                        prevTimestamp: prevProduct.timestamp,
                        currTimestamp: currProduct.timestamp,
                        prevProductCode: prevProduct.productCode,
                        currProductCode: currProduct.productCode, 
                        currModel: currProduct.model,
                        isCrossDay: !isSameDay,
                        isOutlier: !isSameDay, // 跨天样本直接标记为异常
                        reason: !isSameDay ? '跨天样本' : ''
                    };
                    
                    // 如果时间差为负或过大，也标记为异常
                    if (timeDiff <= 0) {
                        sample.isOutlier = true;
                        sample.reason = '时间倒流';
                    } else if (timeDiff > 21600) { // 6小时
                        sample.isOutlier = true;
                        sample.reason = '时间过长';
                    }
                    
                    // 添加样本
                    samplesByModel[prevModel].push(sample);
                }
            });
            
            // 应用第二阶段筛选：剔除超出均值±60%范围的样本
            Object.entries(samplesByModel).forEach(([model, samples]) => {
                // 首先找出非跨天和其他明显异常的样本
                const validSamplesStep1 = samples.filter(sample => !sample.isOutlier);
                
                if (validSamplesStep1.length > 0) {
                    // 计算初步有效样本的平均值
                    const totalTimeStep1 = validSamplesStep1.reduce((sum, sample) => sum + sample.timeDiff, 0);
                    const avgTimeStep1 = totalTimeStep1 / validSamplesStep1.length;
                    
                    // 计算允许范围（均值的40%-160%）
                    const lowerBound = avgTimeStep1 * 0.4;
                    const upperBound = avgTimeStep1 * 1.6;
                    
                    // 标记超出范围的样本
                    samples.forEach(sample => {
                        if (!sample.isOutlier && (sample.timeDiff < lowerBound || sample.timeDiff > upperBound)) {
                            sample.isOutlier = true;
                            sample.reason = '超出均值±60%范围';
                        }
                    });
                }
            });
            
            // 按员工和型号统计结果
            const resultsByEmployee = {};
            const resultsByModel = {};
            
            // 处理每个型号的样本
            Object.entries(samplesByModel).forEach(([model, samples]) => {
                // 获取有效样本
                const validSamples = samples.filter(sample => !sample.isOutlier);
                
                // 按员工分组
                const samplesByEmployee = {};
                samples.forEach(sample => {
                    if (!samplesByEmployee[sample.employee]) {
                        samplesByEmployee[sample.employee] = [];
                    }
                    samplesByEmployee[sample.employee].push(sample);
                });
                
                // 计算每个员工在该型号上的统计数据
                Object.entries(samplesByEmployee).forEach(([employee, empSamples]) => {
                    const validEmpSamples = empSamples.filter(sample => !sample.isOutlier);
                    if (validEmpSamples.length === 0) return;
                    
                    // 计算员工在该型号上的平均时间
                    const totalTime = validEmpSamples.reduce((sum, sample) => sum + sample.timeDiff, 0);
                    const avgTime = totalTime / validEmpSamples.length / 3600; // 转换为小时
                    
                    // 计算中位数
                    const sortedTimes = validEmpSamples.map(sample => sample.timeDiff / 3600).sort((a, b) => a - b); // 转换为小时
                    const medianIndex = Math.floor(sortedTimes.length / 2);
                    const medianTime = sortedTimes.length % 2 === 0 
                        ? (sortedTimes[medianIndex-1] + sortedTimes[medianIndex]) / 2 
                        : sortedTimes[medianIndex];
                    
                    const empModelResult = {
                        employee,
                        model,
                        process: selectedProcess,
                        avgTime,
                        medianTime,
                        minTime: Math.min(...sortedTimes),
                        maxTime: Math.max(...sortedTimes),
                        validCount: validEmpSamples.length,
                        outlierCount: empSamples.length - validEmpSamples.length,
                        crossDayCount: empSamples.filter(sample => sample.isCrossDay).length,
                        outOfRangeCount: empSamples.filter(sample => !sample.isCrossDay && sample.isOutlier).length
                    };
                    
                    // 添加到员工结果
                    if (!resultsByEmployee[employee]) {
                        resultsByEmployee[employee] = [];
                    }
                    resultsByEmployee[employee].push(empModelResult);
                });
                
                // 计算该型号整体统计数据
                if (validSamples.length > 0) {
                    const totalTime = validSamples.reduce((sum, sample) => sum + sample.timeDiff, 0);
                    const avgTime = totalTime / validSamples.length / 3600; // 转换为小时
                    
                    // 计算中位数
                    const sortedTimes = validSamples.map(sample => sample.timeDiff / 3600).sort((a, b) => a - b); // 转换为小时
                    const medianIndex = Math.floor(sortedTimes.length / 2);
                    const medianTime = sortedTimes.length % 2 === 0 
                        ? (sortedTimes[medianIndex-1] + sortedTimes[medianIndex]) / 2 
                        : sortedTimes[medianIndex];
                    
                    resultsByModel[model] = {
                        model,
                        process: selectedProcess,
                        avgTime,
                        medianTime,
                        minTime: Math.min(...sortedTimes),
                        maxTime: Math.max(...sortedTimes),
                        validCount: validSamples.length,
                        outlierCount: samples.length - validSamples.length,
                        crossDayCount: samples.filter(sample => sample.isCrossDay).length,
                        outOfRangeCount: samples.filter(sample => !sample.isCrossDay && sample.isOutlier).length,
                        employees: Object.values(samplesByEmployee).map(emp => emp.employee)
                    };
                }
            });
            
            // 汇总结果
            const timingResults = [];
            
            // 添加型号整体结果
            Object.values(resultsByModel).forEach(modelResult => {
                timingResults.push({
                    employee: '整体平均',
                    process: selectedProcess,
                    model: modelResult.model,
                    avgTime: modelResult.avgTime,
                    medianTime: modelResult.medianTime,
                    minTime: modelResult.minTime,
                    maxTime: modelResult.maxTime,
                    validCount: modelResult.validCount,
                    outlierCount: modelResult.outlierCount,
                    crossDayCount: modelResult.crossDayCount,
                    outOfRangeCount: modelResult.outOfRangeCount,
                    isModelAvg: true
                });
            });
            
            // 添加员工-型号结果
            Object.values(resultsByEmployee).forEach(empResults => {
                empResults.forEach(result => {
                    timingResults.push({
                        employee: result.employee,
                        process: selectedProcess,
                        model: result.model,
                        avgTime: result.avgTime,
                        medianTime: result.medianTime,
                        minTime: result.minTime,
                        maxTime: result.maxTime,
                        validCount: result.validCount,
                        outlierCount: result.outlierCount,
                        crossDayCount: result.crossDayCount,
                        outOfRangeCount: result.outOfRangeCount,
                        isModelAvg: false
                    });
                });
            });
            
            // 显示工序时间表格
            displayTimingTable(timingResults);
            
            // 显示工序时间统计
            displayTimingStats(timingResults);
            
            // 显示工序时间图表
            displayTimingChart(timingResults);
            
            document.getElementById('loading').style.display = 'none';
        }
        
        // 显示工序时间表格
        function displayTimingTable(timingResults) {
            const tableBody = document.getElementById('timing-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // 更新表头，添加跨天样本和超出范围样本列
            const tableHeader = document.getElementById('timing-table').querySelector('thead tr');
            // 确保表头有正确的列
            tableHeader.innerHTML = `
                <th data-sort="employee">员工</th>
                <th data-sort="process">工序</th>
                <th data-sort="model">产品型号</th>
                <th data-sort="avgTime">平均时间(小时)</th>
                <th data-sort="medianTime">中位数时间(小时)</th>
                <th data-sort="validCount">有效样本</th>
                <th data-sort="crossDayCount">跨天样本</th>
                <th data-sort="outOfRangeCount">超范围样本</th>
            `;
            
            if (timingResults.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">没有找到符合条件的数据</td></tr>';
                return;
            }
            
            // 按产品型号分组排序
            timingResults.sort((a, b) => {
                // 首先按产品型号排序
                if (a.model !== b.model) {
                    return a.model.localeCompare(b.model);
                }
                
                // 同一型号内，整体平均排在最前面
                if (a.isModelAvg && !b.isModelAvg) return -1;
                if (!a.isModelAvg && b.isModelAvg) return 1;
                
                // 其他情况按平均时间排序
                return a.avgTime - b.avgTime;
            });
            
            let currentModel = null;
            
            timingResults.forEach(result => {
                const row = document.createElement('tr');
                
                // 为型号总体结果添加不同的样式
                if (result.isModelAvg) {
                    row.style.backgroundColor = '#f0f8ff';
                    row.style.fontWeight = 'bold';
                }
                
                // 如果进入新的产品型号，添加一个分隔行
                if (currentModel !== result.model) {
                    currentModel = result.model;
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `<td colspan="8" style="background-color: #e9ecef; text-align: center; font-weight: bold;">${result.model}</td>`;
                    tableBody.appendChild(separatorRow);
                }
                
                row.innerHTML = `
                    <td>${result.employee}</td>
                    <td>${result.process}</td>
                    <td>${result.model}</td>
                    <td>${result.avgTime.toFixed(1)}</td>
                    <td>${result.medianTime.toFixed(1)}</td>
                    <td>${result.validCount}</td>
                    <td>${result.crossDayCount || 0}</td>
                    <td>${result.outOfRangeCount || 0}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 显示工序时间统计
        function displayTimingStats(timingResults) {
            // 如果没有结果，清空统计
            if (timingResults.length === 0) {
                document.getElementById('avg-time').textContent = '-';
                document.getElementById('min-time').textContent = '-';
                document.getElementById('max-time').textContent = '-';
                document.getElementById('sample-count').textContent = '-';
                document.getElementById('outlier-count').textContent = '-';
                return;
            }
            
            // 筛选型号平均记录
            const modelAverages = timingResults.filter(result => result.isModelAvg);
            
            if (modelAverages.length === 0) return;
            
            // 计算所有型号的总体平均时间
            let totalTime = 0;
            let totalSamples = 0;
            let totalOutliers = 0;
            let totalCrossDays = 0;
            let totalOutOfRange = 0;
            let minTime = Infinity;
            let maxTime = 0;
            
            modelAverages.forEach(result => {
                totalTime += result.avgTime * result.validCount;
                totalSamples += result.validCount;
                totalOutliers += result.outlierCount;
                totalCrossDays += result.crossDayCount || 0;
                totalOutOfRange += result.outOfRangeCount || 0;
                minTime = Math.min(minTime, result.minTime);
                maxTime = Math.max(maxTime, result.maxTime);
            });
            
            const overallAvgTime = totalTime / totalSamples;
            
            // 更新统计显示
            document.getElementById('avg-time').textContent = `${overallAvgTime.toFixed(2)} 小时`;
            document.getElementById('min-time').textContent = `${minTime.toFixed(2)} 小时`;
            document.getElementById('max-time').textContent = `${maxTime.toFixed(2)} 小时`;
            document.getElementById('sample-count').textContent = totalSamples;
            
            // 更新异常值显示
            // 创建异常值详细信息
            const outlierDetail = `总计: ${totalOutliers} (跨天: ${totalCrossDays}, 超范围: ${totalOutOfRange})`;
            document.getElementById('outlier-count').innerHTML = outlierDetail;
            
            // 添加有效率显示
            const validRateElement = document.getElementById('timing-stats').querySelector('.stat-card:last-child .stat-value');
            if (validRateElement) {
                const validRate = (totalSamples / (totalSamples + totalOutliers) * 100).toFixed(1);
                validRateElement.textContent = `${validRate}%`;
            }
        }
        
        // 显示工序时间图表
        function displayTimingChart(timingResults) {
            const ctx = document.getElementById('timing-chart').getContext('2d');
            
            // 如果没有结果，清空图表
            if (timingResults.length === 0) {
                if (timingChart) {
                    timingChart.destroy();
                    timingChart = null;
                }
                return;
            }
            
            // 筛选有足够样本的型号平均结果（至少3个有效样本）
            const modelAverages = timingResults.filter(result => result.isModelAvg && result.validCount >= 3);
            
            if (modelAverages.length === 0) {
                // 如果没有满足条件的型号平均，则回退到之前的按员工展示
                const validResults = timingResults.filter(result => !result.isModelAvg && result.validCount >= 3);
                
                if (validResults.length === 0) {
                    if (timingChart) {
                        timingChart.destroy();
                        timingChart = null;
                    }
                    return;
                }
                
                // 准备图表数据
                const labels = validResults.map(result => `${result.employee} (${result.model})`);
                const avgTimes = validResults.map(result => result.avgTime);
                const medianTimes = validResults.map(result => result.medianTime);
                const sampleCounts = validResults.map(result => result.validCount);
                const crossDayCounts = validResults.map(result => result.crossDayCount || 0);
                const outOfRangeCounts = validResults.map(result => result.outOfRangeCount || 0);
                
                // 如果已存在图表，销毁它
                if (timingChart) {
                    timingChart.destroy();
                }
                
                // 创建新图表 - 员工视图
                timingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '平均时间 (小时)',
                            data: avgTimes,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        }, {
                            label: '中位数时间 (小时)',
                            data: medianTimes,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }, {
                            label: '有效样本',
                            data: sampleCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }, {
                            label: '跨天样本',
                            data: crossDayCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderDash: [5, 5],
                            tension: 0.1,
                            yAxisID: 'y1'
                        }, {
                            label: '超范围样本',
                            data: outOfRangeCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderDash: [3, 3],
                            tension: 0.1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '时间 (小时)'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '样本数量'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${document.getElementById('timing-process').value}工序时间分析 (按员工)`
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const index = context.dataIndex;
                                        const result = validResults[index];
                                        return [
                                            `有效样本: ${result.validCount}`, 
                                            `跨天样本: ${result.crossDayCount || 0}`,
                                            `超范围样本: ${result.outOfRangeCount || 0}`,
                                            `有效率: ${(result.validCount / (result.validCount + result.outlierCount) * 100).toFixed(1)}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // 如果有足够的型号平均数据，创建按产品型号的图表
                // 准备图表数据
                const labels = modelAverages.map(result => result.model);
                const avgTimes = modelAverages.map(result => result.avgTime);
                const medianTimes = modelAverages.map(result => result.medianTime);
                const sampleCounts = modelAverages.map(result => result.validCount);
                const crossDayCounts = modelAverages.map(result => result.crossDayCount || 0);
                const outOfRangeCounts = modelAverages.map(result => result.outOfRangeCount || 0);
                
                // 如果已存在图表，销毁它
                if (timingChart) {
                    timingChart.destroy();
                }
                
                // 创建新图表 - 型号视图
                timingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '平均时间 (小时)',
                            data: avgTimes,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        }, {
                            label: '中位数时间 (小时)',
                            data: medianTimes,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }, {
                            label: '有效样本',
                            data: sampleCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }, {
                            label: '跨天样本',
                            data: crossDayCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderDash: [5, 5],
                            tension: 0.1,
                            yAxisID: 'y1'
                        }, {
                            label: '超范围样本',
                            data: outOfRangeCounts,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderDash: [3, 3],
                            tension: 0.1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '时间 (小时)'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '样本数量'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${document.getElementById('timing-process').value}工序时间分析 (按产品型号)`
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const index = context.dataIndex;
                                        const result = modelAverages[index];
                                        return [
                                            `有效样本: ${result.validCount}`, 
                                            `跨天样本: ${result.crossDayCount || 0}`,
                                            `超范围样本: ${result.outOfRangeCount || 0}`,
                                            `有效率: ${(result.validCount / (result.validCount + result.outlierCount) * 100).toFixed(1)}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
